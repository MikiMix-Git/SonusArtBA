<!-- Verzija 1.81 - AI Asistent za Postavku Sistema (Detaljna usporedba specifikacija) -->
<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonus Art - Audio Proizvodi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        input, select, textarea {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 5px;
        }
        input {
            width: 200px;
        }
        textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
        }
        .toggle-btn, .overview-product-btn, .recommend-product-btn, .setup-assistant-btn {
            font-size: 14px;
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .toggle-btn:hover, .overview-product-btn:hover, .recommend-product-btn:hover, .setup-assistant-btn:hover {
            background-color: #218838;
        }
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .product {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .product h3 {
            margin: 0 0 10px;
            color: #333;
        }
        .product img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .product p {
            margin: 5px 0;
        }
        .product .spec-item {
            margin-bottom: 5px;
            font-size: 14px;
            text-align: left;
            width: 100%;
        }
        .long-description {
            display: none;
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            text-align: left;
            width: 100%;
        }
        .long-description.show {
            display: block;
        }
        .clickable {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        .clickable:hover {
            color: #0056b3;
        }
        .error, .no-products {
            text-align: center;
            color: #ff0000;
        }

        /* Stilovi za usporedbu */
        .compare-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        #comparisonTableContainer {
            overflow-x: auto;
        }
        #comparisonTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #comparisonTable th, #comparisonTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        #comparisonTable th {
            background-color: #f2f2f2;
            font-weight: bold;
            white-space: nowrap;
        }
        #comparisonTable td ul {
            margin: 0;
            padding-left: 20px;
        }

        /* Stilovi za plutajuće dugmad */
        #floatingComparisonControls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #floatingComparisonControls button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #compareButton {
            background-color: #007bff;
            color: white;
        }
        #compareButton:hover {
            background-color: #0056b3;
        }
        #compareButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #clearComparisonButton {
            background-color: #dc3545;
            color: white;
        }
        #clearComparisonButton:hover {
            background-color: #c82333;
        }
        #clearComparisonButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #setupAssistantButton {
            background-color: #ffc107;
            color: #333;
        }
        #setupAssistantButton:hover {
            background-color: #e0a800;
        }

        /* Stilovi za poruke */
        .message-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .message-area.error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-area.info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Stilovi za Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }
        .modal-close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Stilovi za Gemini analizu */
        #geminiAnalysisContainer, #productOverviewContainer, #recommendationContainer, #setupAdviceContainer {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ef;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            text-align: left;
            white-space: pre-wrap;
            font-size: 14px;
            color: #155724;
        }
        #geminiAnalysisContainer.loading, #productOverviewContainer.loading, #recommendationContainer.loading, #setupAdviceContainer.loading {
            text-align: center;
            font-style: italic;
            color: #6c757d;
        }
        .analysis-buttons, .product-overview-buttons, .recommendation-buttons, .setup-assistant-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .analysis-buttons button, .product-overview-buttons button, .recommendation-buttons button, .setup-assistant-buttons button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #analyzeComparisonButton {
            background-color: #6f42c1;
            color: white;
        }
        #analyzeComparisonButton:hover {
            background-color: #5a359c;
        }
        #analyzeComparisonButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #generateSetupAdviceButton {
            background-color: #007bff;
            color: white;
        }
        #generateSetupAdviceButton:hover {
            background-color: #0056b3;
        }
        #generateSetupAdviceButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Stilovi za prikaz preporučenih proizvoda unutar modala */
        .recommended-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .recommended-product-card {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
        }
        .recommended-product-card:hover {
            background-color: #e2e6ea;
        }
        .recommended-product-card img {
            max-width: 100px;
            height: auto;
            border-radius: 3px;
            margin-bottom: 5px;
        }
        .recommended-product-card h4 {
            margin: 5px 0;
            color: #333;
            font-size: 16px;
        }
        .recommended-product-card p {
            margin: 2px 0;
            font-size: 13px;
            color: #555;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 10px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sonus Art - Audio Proizvodi</h1>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Pretraži po nazivu...">
            <label for="categoryFilter">Kategorija:</label>
            <select id="categoryFilter">
                <option value="">Sve kategorije</option>
            </select>
            <label for="seriesFilter">Serija:</label>
            <select id="seriesFilter">
                <option value="">Sve serije</option>
            </select>
            <label for="brandFilter">Brend:</label>
            <select id="brandFilter">
                <option value="">Svi brendovi</option>
                <!-- Opcije za brendove će se sada dinamički popunjavati putem JavaScripta -->
            </select>
            <label for="seriesSort">Sortiraj po seriji:</label>
            <select id="seriesSort">
                <option value="">Zadano</option>
                <option value="asc">Serija (A-Ž)</option>
                <option value="desc">Serija (Ž-A)</option>
            </select>
        </div>
        <!-- Nova oblast za poruke -->
        <div id="mainMessageArea" class="message-area"></div>
        <div id="products" class="products"></div>
    </div>

    <!-- Plutajuće dugmad za usporedbu -->
    <div id="floatingComparisonControls">
        <button id="compareButton" onclick="showComparisonModal()" disabled>Usporedi (0)</button>
        <button id="clearComparisonButton" onclick="clearComparison()" disabled>Očisti usporedbu</button>
        <button id="setupAssistantButton" onclick="showSetupAssistantModal()">AI Asistent za Postavku Sustava</button>
    </div>

    <!-- Modal za usporedbu -->
    <div id="comparisonModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeComparisonModal()">&times;</span>
            <h2>Usporedba proizvoda</h2>
            <div id="comparisonMessageArea" class="message-area"></div>
            <div id="comparisonTableContainer">
                <!-- Tabela za usporedbu će biti generisana ovde -->
            </div>
            <div class="analysis-buttons">
                <button id="analyzeComparisonButton" onclick="analyzeComparisonWithGemini()" disabled>Analiziraj usporedbu</button>
            </div>
            <div id="geminiAnalysisContainer"></div>
        </div>
    </div>

    <!-- Novi Modal za AI Review Proizvoda -->
    <div id="productOverviewModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeProductOverviewModal()">&times;</span>
            <h2 id="productOverviewTitle">AI Recenzija proizvoda</h2>
            <div id="productOverviewMessageArea" class="message-area"></div>
            <div class="product-overview-buttons">
            </div>
            <div id="productOverviewContainer"></div>
        </div>
    </div>

    <!-- Novi Modal za Preporuke Proizvoda -->
    <div id="recommendationModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeRecommendationModal()">&times;</span>
            <h2 id="recommendationTitle">Preporučeni proizvodi</h2>
            <div id="recommendationMessageArea" class="message-area"></div>
            <div class="recommendation-buttons">
            </div>
            <div id="recommendationContainer">
            </div>
        </div>
    </div>

    <!-- Novi Modal za AI Asistent za Postavku Sistema -->
    <div id="setupAssistantModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeSetupAssistantModal()">&times;</span>
            <h2 id="setupAssistantTitle">AI Asistent za Postavku Sustava</h2>
            <div id="setupAssistantMessageArea" class="message-area"></div>
            
            <div class="form-group">
                <label for="selectProductForSetup">Odaberite proizvod za savjet o postavci:</label>
                <select id="selectProductForSetup"></select>
            </div>

            <h3>Detalji o prostoriji (u metrima):</h3>
            <div class="form-group">
                <label for="roomLength">Duljina sobe:</label>
                <input type="number" id="roomLength" placeholder="npr. 5.0" step="0.1" min="1">
            </div>
            <div class="form-group">
                <label for="roomWidth">Širina sobe:</label>
                <input type="number" id="roomWidth" placeholder="npr. 4.0" step="0.1" min="1">
            </div>
            <div class="form-group">
                <label for="roomHeight">Visina sobe:</label>
                <input type="number" id="roomHeight" placeholder="npr. 2.5" step="0.1" min="1">
            </div>

            <div class="form-group">
                <label for="floorType">Tip poda:</label>
                <select id="floorType">
                    <option value="Hardwood">Tvrdo drvo / Laminat</option>
                    <option value="Carpet">Tepih</option>
                    <option value="Tile">Pločice</option>
                    <option value="Mixed">Miješano</option>
                </select>
            </div>

            <div class="form-group">
                <label for="furnitureDensity">Gustina namještaja:</label>
                <select id="furnitureDensity">
                    <option value="Minimal">Minimalna (malo namještaja)</option>
                    <option value="Moderate">Umjerena (standardan namještaj)</option>
                    <option value="Dense">Gusta (mnogo namještaja)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="listeningPreferences">Vaše preferencije slušanja (npr. 'Volim snažan bas i jasne vokale', 'Slušam uglavnom klasičnu glazbu'):</label>
                <textarea id="listeningPreferences" placeholder="Opišite svoje preferencije..."></textarea>
            </div>

            <div class="setup-assistant-buttons">
                <button id="generateSetupAdviceButton" onclick="generateSetupAdvice()">Generiraj savjet za postavku</button>
            </div>
            <div id="setupAdviceContainer"></div>
        </div>
    </div>

    <script>
        // Verzija 1.81
        // URL-ovi JSON fajlova sa podacima o proizvodima
        const jsonUrls = [
            "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/Argon%20Audio.json",
            "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/Bowers%20%26%20Wilkins.json",
            "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/Bang%20%26%20Olufsen.json",
            "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/Dynaudio.json",
            "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/Polk%20Audio.json",
            "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/Q-Acoustics.json",
            "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/Marantz.json",
        ];

        // Globalna varijabla za sve učitane proizvode
        let allProductsData = [];
        // Globalna varijabla za proizvode odabrane za usporedbu
        let productsToCompare = [];
        const MAX_PRODUCTS_TO_COMPARE = 4; // Maksimalan broj proizvoda za usporedbu
        // Globalna varijabla za praćenje izabranog filtera specifikacije (ključ i vrednost)
        let currentSelectedSpecFilter = { key: null, value: null };
        // Nova globalna varijabla za indeksiranje proizvoda
        const productIndex = new Map();

        // Mapa za prevođenje ključeva na hrvatski jezik
        const translationMap = {
            "name": "Naziv",
            "brand": "Brend",
            "series": "Serija",
            "category": "Kategorija",
            "subcategory": "Potkategorija",
            "description": "Kratki opis",
            "longDescription": "Dugi opis",
            "intended_use": "Namjena",
            "price_usd": "Cijena",
            "finishes": "Završne obrade",
            "imageUrl": "Slika",
            "warranty_duration": "Trajanje jamstva (godine)",
            "release_year": "Godina izdanja",
            "comparison_score": "Ocjena usporedbe",
            "specifications": "Specifikacije",
            "type": "Tip",
            "min_frequency": "Minimalna frekvencija (Hz)",
            "max_frequency": "Maksimalna frekvencija (Hz)",
            "amplifier_power": "Snaga pojačala",
            "amplifier_power_watts": "Snaga pojačala (W)",
            "sensitivity": "Osjetljivost (dB)",
            "nominal_impedance": "Nominalna impedancija (Ω)",
            "inputs": "Ulazi",
            "outputs": "Izlazi",
            "connectivity": "Povezivost",
            "dimensions": "Dimenzije",
            "height_mm": "Visina (mm)",
            "width_mm": "Širina (mm)",
            "depth_mm": "Dubina (mm)",
            "weight_kg": "Težina (kg)",
            "technologies": "Tehnologije",
            "supported_formats": "Podržani formati",
            "drive_system": "Sustav pogona",
            "cartridge": "Zvučnica",
            "speeds": "Brzine (RPM)",
            "signal_to_noise_ratio": "Odnos signal/šum (dB)",
            "drivers": "Zvučničke jedinice",
            "woofer": "Woofer",
            "tweeter": "Tweeter",
            "midrange": "Srednjetonac",
            "frequency_response": "Frekvencijski odziv",
            "power_output": "Izlazna snaga",
            "channels": "Kanali",
            "dac": "DAC",
            "phono_input": "Phono ulaz",
            "streaming_services": "Streaming servisi",
            "control_app": "Kontrolna aplikacija",
            "voice_control": "Glasovna kontrola",
            "multi_room": "Multi-room",
            "features": "Značajke",
            "recommended_amplifier_power": "Preporučena snaga pojačala",
            "status": "Status" // Dodano za 'status' polje
        };

        /**
         * Prikazuje poruku u definisanom delu UI-ja.
         * @param {string} message - Tekst poruke.
         * @param {string} type - Tip poruke ('error' ili 'info').
         * @param {string} targetAreaId - ID elementa u kojem će se prikazati poruka (npr. 'comparisonMessageArea', 'productOverviewMessageArea', 'recommendationMessageArea', 'setupAssistantMessageArea').
         */
        function displayUIMessage(message, type, targetAreaId = "comparisonMessageArea") {
            const messageArea = document.getElementById(targetAreaId);
            if (messageArea) {
                messageArea.textContent = message;
                messageArea.className = `message-area ${type}-message`;
                setTimeout(() => {
                    messageArea.textContent = '';
                    messageArea.className = 'message-area';
                }, 5000);
            }
        }

        /**
         * Pomoćna funkcija za normalizaciju specifikacija u objekat ključ-vrednost.
         * Prihvata specifikacije kao niz stringova ("Ključ: Vrednost") ili kao objekat.
         * @param {Object} product - Objekat proizvoda.
         * @returns {Object} Normalizovani objekat specifikacija.
         */
        function getNormalizedSpecifications(product) {
            const normalizedSpecs = {};
            if (product.specifications) {
                if (Array.isArray(product.specifications)) {
                    for (const specString of product.specifications) {
                        const cleanedString = specString.replace(/^\d+:\s*/, '');
                        const parts = cleanedString.split(': ', 2);
                        if (parts.length === 2) {
                            normalizedSpecs[parts[0].trim()] = parts[1].trim();
                        }
                    }
                } else if (typeof product.specifications === 'object') {
                    Object.assign(normalizedSpecs, product.specifications);
                }
            }
            return normalizedSpecs;
        }

        /**
         * Pomoćna funkcija za parsiranje opsega snage (npr. "50-300W" ili "100W").
         * Vraća objekat {min: number, max: number} ili null.
         */
        function parsePowerRange(powerString) {
            if (!powerString) return null;
            let match;
            match = powerString.match(/(\d+)\s*W?\s*[–-]\s*(\d+)\s*W?/i);
            if (match) {
                const min = parseInt(match[1]);
                const max = parseInt(match[2]);
                return { min, max };
            }
            match = powerString.match(/^(\d+)\s*W$/i);
            if (match) {
                const power = parseInt(match[1]);
                return { min: power, max: power };
            }
            return null;
        }

        /**
         * Pomoćna funkcija za parsiranje impedanse (npr. "6 Ohma" ili "4-8 Ohma" ili "8Ω (minimum 3.0Ω)").
         * Vraća broj ili objekat {min: number, max: number} ili null.
         */
        function parseImpedance(impedanceString) {
            if (!impedanceString) {
                return null;
            }
            const matchMinMax = impedanceString.match(/^(\d+(?:\.\d+)?)\s*(?:Ω|Ohma)(?:\s*\(\s*minimum\s*(\d+(?:\.\d+)?)\s*(?:Ω|Ohma)\s*\))?$/i);
            if (matchMinMax) {
                const nominal = parseFloat(matchMinMax[1]);
                const minimum = matchMinMax[2] ? parseFloat(matchMinMax[2]) : nominal;
                return { min: minimum, max: nominal };
            }
            const matchRange = impedanceString.match(/^(\d+(?:\.\d+)?)\s*-\s*(\d+(?:\.\d+)?)\s*(?:Ω|Ohma)$/i);
            if (matchRange) {
                return { min: parseFloat(matchRange[1]), max: parseFloat(matchRange[2]) };
            }
            const matchSingle = impedanceString.match(/^(\d+(?:\.\d+)?)\s*(?:Ω|Ohma)$/i);
            if (matchSingle) {
                const singleVal = parseFloat(matchSingle[1]);
                return { min: singleVal, max: singleVal };
            }
            return null;
        }

        /**
         * Dohvaća izlaznu snagu pojačala.
         * Prioritetno traži snagu pri 8 Ohma, zatim 4 Ohma, pa generičku snagu.
         * @param {Object} specs - Normalizovane specifikacije proizvoda.
         * @returns {number | null} Izlazna snaga u vatima ili null.
         */
        function getAmplifierOutputPower(specs) {
            const powerStr = specs["Izlazna snaga"] || specs["Snaga"] || specs["amplifier_power"] || specs["amplifier_power_watts"];
            if (!powerStr) {
                return null;
            }

            if (typeof powerStr === 'number') {
                return powerStr;
            }

            let match;
            match = powerStr.match(/(\d+)W\s*po kanalu\s*\(8Ω\)/i) || powerStr.match(/(\d+)W\s*po kanalu\s*\(8\s*Ohma\)/i);
            if (match) {
                return parseInt(match[1]);
            }
            match = powerStr.match(/(\d+)W\s*po kanalu\s*\(4Ω\)/i) || powerStr.match(/(\d+)W\s*po kanalu\s*\(4\s*Ohma\)/i);
            if (match) {
                return parseInt(match[1]);
            }
            match = powerStr.match(/(\d+)\s*W/i);
            if (match) {
                return parseInt(match[1]);
            }
            return null;
        }

        /**
         * Extracts impedance values from a power string (e.g., "150W na 8 Ohma, 250W na 4 Ohma").
         * Returns an array of numbers or an empty array.
         */
        function extractImpedanceFromPowerString(powerString) {
            if (!powerString) return [];
            const impedances = [];
            let matches = powerString.matchAll(/na (\d+(?:\.\d+)?)\s*(?:Ohma|Ω)/gi);
            for (const match of matches) {
                impedances.push(parseFloat(match[1]));
            }
            matches = powerString.matchAll(/\((\d+(?:\.\d+)?)\s*(?:Ω|Ohma)\)/gi);
            for (const match of matches) {
                impedances.push(parseFloat(match[1]));
            }
            matches = powerString.matchAll(/\b(\d+(?:\.\d+)?)\s*(?:Ω|Ohma)\b(?!W)/gi);
            for (const match of matches) {
                const preMatch = powerString.substring(0, match.index);
                if (!preMatch.match(/\d+\s*W$/i)) {
                    impedances.push(parseFloat(match[1]));
                }
            }
            const uniqueImpedances = [...new Set(impedances)].sort((a, b) => a - b);
            return uniqueImpedances;
        }

        /**
         * Dohvaća podržani raspon impedanse zvučnika za pojačalo.
         * Prvo provjerava "Impedansa zvučnika", zatim "Podržana impedansa zvučnika" ili "Impedansa".
         * Ako nije pronađeno, pokušava izvući iz "Izlazna snaga".
         * @param {Object} specs - Normalizovane specifikacije proizvoda.
         * @returns {{min: number, max: number} | null} Raspon impedanse ili null.
         */
        function getAmplifierSupportedImpedanceRange(specs) {
            let impedanceStr = specs["Impedansa zvučnika"] || specs["Podržana impedansa zvučnika"] || specs["Impedansa"] || specs["nominal_impedance"] || specs["impedance"];
            let parsedImpedance = parseImpedance(impedanceStr);
            if (parsedImpedance) {
                return toImpedanceRange(parsedImpedance);
            }
            const powerOutputStr = specs["Izlazna snaga"] || specs["Snaga"] || specs["amplifier_power"];
            if (powerOutputStr) {
                const extractedImpedances = extractImpedanceFromPowerString(powerOutputStr);
                if (extractedImpedances.length > 0) {
                    const minImpedance = Math.min(...extractedImpedances);
                    const maxImpedance = Math.max(...extractedImpedances);
                    return { min: minImpedance, max: maxImpedance };
                }
            }
            return null;
        }

        /**
         * Helper to convert single number impedance to a range object.
         * @param {number|{min:number, max:number}|null} val - Impedance value.
         * @returns {{min:number, max:number}|null} Impedance as a range object.
         */
        function toImpedanceRange(val) {
            if (typeof val === 'number') {
                return { min: val, max: val };
            }
            return val;
        }

        /**
         * Helper to check if two impedance ranges overlap.
         * @param {{min:number, max:number}|null} range1 - First impedance range.
         * @param {{min:number, max:number}|null} range2 - Second impedance range.
         * @returns {boolean} True if ranges overlap, false otherwise.
         */
        function doImpedanceRangesOverlap(range1, range2) {
            if (!range1 || !range2 || typeof range1.min === 'undefined' || typeof range1.max === 'undefined' || typeof range2.min === 'undefined' || typeof range2.max === 'undefined') {
                return false;
            }
            return Math.max(range1.min, range2.min) <= Math.min(range1.max, range2.max);
        }

        /**
         * Popunjava padajuće menije za kategorije, serije i brendove na osnovu dostupnih proizvoda.
         * Takođe učitava sve podatke o proizvodima u `allProductsData`.
         */
        async function populateFilters() {
            try {
                const responses = await Promise.all(jsonUrls.map(url => fetch(url).then(res => {
                    if (!res.ok) {
                        console.error(`Greška pri učitavanju JSON fajla: ${url}, Status: ${res.status}`);
                        throw new Error(`Neuspješno učitavanje: ${url}`);
                    }
                    return res.json();
                }).catch(error => {
                    console.error(`Greška pri dohvaćanju ${url}:`, error);
                    return null;
                })));
                
                allProductsData = [];
                const categoriesSet = new Set();
                const seriesSet = new Set();
                const brandsSet = new Set();

                responses.forEach((data, index) => {
                    const url = jsonUrls[index];
                    if (data === null) {
                        console.warn(`Preskačem obradu podataka iz URL-a zbog greške pri učitavanju: ${url}`);
                        return;
                    }

                    // Proveri da li je struktura sa "categories" (kao Argon Audio)
                    if (data.categories && Array.isArray(data.categories)) {
                        data.categories.forEach(categoryObj => {
                            categoriesSet.add(categoryObj.name);
                            if (categoryObj.subcategories && Array.isArray(categoryObj.subcategories)) {
                                categoryObj.subcategories.forEach(subCategoryObj => {
                                    if (subCategoryObj.models && Array.isArray(subCategoryObj.models)) {
                                        subCategoryObj.models.forEach(model => {
                                            allProductsData.push({
                                                ...model,
                                                category: categoryObj.name,
                                                subcategory: subCategoryObj.name
                                            });
                                            brandsSet.add(model.brand);
                                            if (model.series) {
                                                seriesSet.add(model.series);
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                    // Proveri da li je struktura sa "brand" i "products" (kao Marantz)
                    else if (data.brand && data.products && Array.isArray(data.products)) {
                        brandsSet.add(data.brand);
                        data.products.forEach(product => {
                            allProductsData.push({
                                ...product,
                                brand: data.brand
                            });
                            categoriesSet.add(product.category);
                            if (product.series) {
                                seriesSet.add(product.series);
                            }
                        });
                    } else {
                        console.warn(`JSON fajl sa URL-a ${url} ne prati očekivanu strukturu ('categories' ili 'brand'/'products') i biće preskočen:`, data);
                    }
                });

                indexProducts();

                const categoryFilter = document.getElementById("categoryFilter");
                categoryFilter.innerHTML = '<option value="">Sve kategorije</option>';
                Array.from(categoriesSet).sort().forEach(category => {
                    const option = document.createElement("option");
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });

                const seriesFilter = document.getElementById("seriesFilter");
                seriesFilter.innerHTML = '<option value="">Sve serije</option>';
                Array.from(seriesSet).sort().forEach(s => {
                    const option = document.createElement("option");
                    option.value = s;
                    option.textContent = s;
                    seriesFilter.appendChild(option);
                });

                const brandFilter = document.getElementById("brandFilter");
                brandFilter.innerHTML = '<option value="">Svi brendovi</option>';
                Array.from(brandsSet).sort().forEach(brand => {
                    const option = document.createElement("option");
                    option.value = brand;
                    option.textContent = brand;
                    brandFilter.appendChild(option);
                });

            } catch (error) {
                console.error('Greška pri učitavanju i obradi podataka:', error);
                document.getElementById('products').innerHTML = `<p class="error">Došlo je do greške prilikom učitavanja proizvoda. Molimo pokušajte ponovo kasnije.</p>`;
            }
            filterProducts(); // Inicijalno filtriranje i prikaz svih proizvoda
        }

        /**
         * Kreira i prikazuje HTML karticu za pojedinačni proizvod.
         * @param {Object} product - Objekat proizvoda.
         * @param {boolean} isSelected - Da li je proizvod odabran za usporedbu.
         * @returns {string} HTML string za karticu proizvoda.
         */
        function createProductCardHtml(product, isSelected) {
            let productDetailsHtml = '';
            const excludedKeys = ['id', 'longDescription', 'imageUrl', 'price_usd', 'specifications']; // Ključevi koje ne želimo prikazati direktno ili su već obrađeni

            for (const key in product) {
                if (product.hasOwnProperty(key) && !excludedKeys.includes(key)) {
                    let value = product[key];
                    let displayKey = translationMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Koristi mapu za prevođenje

                    if (key === 'price_usd') {
                        continue;
                    } else if (key === 'imageUrl') {
                        continue;
                    } else if (key === 'longDescription') {
                        continue;
                    } else if (key === 'specifications') {
                        continue;
                    } else if (Array.isArray(value)) {
                        productDetailsHtml += `<p class="spec-item"><strong>${displayKey}:</strong><ul>`;
                        value.forEach(item => {
                            if (typeof item === 'object' && item !== null) {
                                productDetailsHtml += `<li>`;
                                for (const subKey in item) {
                                    const translatedSubKey = translationMap[subKey] || subKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    productDetailsHtml += `<strong>${translatedSubKey}:</strong> ${escapeHtml(String(item[subKey]))} `;
                                }
                                productDetailsHtml += `</li>`;
                            } else {
                                productDetailsHtml += `<li>${escapeHtml(String(item))}</li>`;
                            }
                        });
                        productDetailsHtml += `</ul></p>`;
                    } else if (typeof value === 'object' && value !== null) {
                        productDetailsHtml += `<p class="spec-item"><strong>${displayKey}:</strong><ul>`;
                        for (const subKey in value) {
                            const translatedSubKey = translationMap[subKey] || subKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            productDetailsHtml += `<li><strong>${translatedSubKey}:</strong> ${escapeHtml(String(value[subKey]))}</li>`;
                        }
                        productDetailsHtml += `</ul></p>`;
                    } else {
                        productDetailsHtml += `<p class="spec-item"><strong>${displayKey}:</strong> ${escapeHtml(String(value) || 'N/A')}</p>`;
                    }
                }
            }

            const specifications = product.specifications;
            let specificationsHtml = '';
            if (specifications && Object.keys(specifications).length > 0) {
                specificationsHtml += `<h4>Specifikacije:</h4>`;
                for (const key in specifications) {
                    const value = specifications[key];
                    const displayKey = translationMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                    if (Array.isArray(value)) {
                        specificationsHtml += `<p class="spec-item"><strong>${displayKey}:</strong><ul>`;
                        value.forEach(item => {
                            if (typeof item === 'object' && item !== null) {
                                specificationsHtml += `<li>`;
                                for (const subKey in item) {
                                    const translatedSubKey = translationMap[subKey] || subKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    productDetailsHtml += `<strong>${translatedSubKey}:</strong> ${escapeHtml(String(item[subKey]))} `;
                                }
                                specificationsHtml += `</li>`;
                            } else {
                                specificationsHtml += `<li>${escapeHtml(String(item))}</li>`;
                            }
                        });
                        specificationsHtml += `</ul></p>`;
                    } else if (typeof value === 'object' && value !== null) {
                        specificationsHtml += `<p class="spec-item"><strong>${displayKey}:</strong><ul>`;
                        for (const subKey in value) {
                            const translatedSubKey = translationMap[subKey] || subKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            specificationsHtml += `<li><strong>${translatedSubKey}:</strong> ${escapeHtml(String(value[subKey]))}</li>`;
                        }
                        specificationsHtml += `</ul></p>`;
                    } else {
                        // Dodata logika za klikabilne specifikacije
                        if (["Tip", "Tip zvučnika", "Tip drajvera", "Pogon", "Impedansa", "Preporučena snaga pojačala", "Povezivanje", "Nominalna impedansa", "inputs", "outputs", "technologies", "features", "recommended_amplifier_power", "connectivity", "supported_formats", "speeds", "drive_system", "cartridge"].includes(key) || translationMap[key]) {
                            const fullValue = String(value);
                            let clickableParts = [];
                            const commaSeparated = fullValue.split(',').map(part => part.trim());

                            commaSeparated.forEach(part => {
                                const parenthesisMatch = part.match(/(.*?)\s*\((.*?)\)/);
                                if (parenthesisMatch) {
                                    const mainPart = parenthesisMatch[1].trim();
                                    if (mainPart) {
                                        clickableParts.push(mainPart);
                                    }
                                    const innerPart = parenthesisMatch[2].trim();
                                    if (innerPart) {
                                        clickableParts.push(innerPart);
                                    }
                                } else {
                                    if (part) {
                                        clickableParts.push(part);
                                    }
                                }
                            });

                            clickableParts = clickableParts.filter(p => p !== '');

                            let clickablePartsHtml = clickableParts.map(part => {
                                return `<span class="clickable filter-spec" data-spec-key="${escapeHtml(key)}" data-spec-value="${encodeURIComponent(part)}">${escapeHtml(part)}</span>`;
                            }).join(', ');
                            specificationsHtml += `<p class="spec-item"><strong>${displayKey}:</strong> ${clickablePartsHtml}</p>`;
                        } else {
                            specificationsHtml += `<p class="spec-item"><strong>${displayKey}:</strong> ${escapeHtml(String(value) || 'N/A')}</p>`;
                        }
                    }
                }
            } else {
                specificationsHtml = '<p>Nema dostupnih specifikacija.</p>';
            }

            const longDescriptionHtml = product.longDescription ?
                `<div class="long-description">${escapeHtml(product.longDescription)}</div><a href="#" class="clickable toggle-description">Pročitaj više</a>` : '';

            const checkboxId = `compare-${product.id}`;

            return `
                <div class="product" data-product-id="${product.id}">
                    <input type="checkbox" id="${checkboxId}" class="compare-checkbox" data-product-id="${product.id}" ${isSelected ? 'checked' : ''} onclick="handleComparisonCheckboxClick(event, '${product.id}')">
                    <img src="${escapeHtml(product.imageUrl)}" alt="${escapeHtml(product.name)}" onerror="this.src='https://placehold.co/150x150/cccccc/ffffff?text=Nema slike';">
                    <h3>${escapeHtml(product.name)}</h3>
                    ${productDetailsHtml}
                    <p class="spec-item"><strong>${translationMap['price_usd']}:</strong> ${escapeHtml(product.price_usd || 'N/A')} USD</p>
                    ${specificationsHtml}
                    ${longDescriptionHtml}
                    <button class="overview-product-btn" onclick="showProductOverviewModal('${product.id}')">AI Recenzija Proizvoda</button>
                    <button class="recommend-product-btn" onclick="showRecommendationModal('${product.id}')">AI Preporuka Proizvoda</button>
                </div>
            `;
        }

        /**
         * Funkcija za renderovanje proizvoda na stranici.
         * @param {Array} productsToRender - Niz proizvoda koje treba prikazati.
         */
        function renderProducts(productsToRender) {
            const productsContainer = document.getElementById("products");
            productsContainer.innerHTML = "";
            if (productsToRender.length === 0) {
                productsContainer.innerHTML = '<p class="no-products">Nema pronađenih proizvoda koji odgovaraju kriterijima pretrage.</p>';
                return;
            }
            productsToRender.forEach(product => {
                const productId = `${encodeURIComponent(product.brand)}-${encodeURIComponent(product.name)}`;
                const isSelected = productsToCompare.some(p => `${encodeURIComponent(p.brand)}-${encodeURIComponent(p.name)}` === productId);
                productsContainer.innerHTML += createProductCardHtml({ ...product, id: productId }, isSelected);
            });
            // Dodajemo event listener-e za "Pročitaj više" linkove
            productsContainer.querySelectorAll('.toggle-description').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const card = event.target.closest('.product');
                    const description = card.querySelector('.long-description');
                    description.classList.toggle('show');
                    event.target.textContent = description.classList.contains('show') ? 'Prikaži manje' : 'Pročitaj više';
                });
            });
        }

        /**
         * Indeksira sve proizvode u globalnu mapu `productIndex` radi bržeg pristupa.
         * Poziva se nakon učitavanja podataka.
         */
        function indexProducts() {
            productIndex.clear();
            allProductsData.forEach(product => {
                const productId = `${encodeURIComponent(product.brand)}-${encodeURIComponent(product.name)}`;
                productIndex.set(productId, product);
            });
            console.log(`Indeksirano ${productIndex.size} proizvoda.`);
        }

        /**
         * Glavna funkcija za filtriranje i sortiranje proizvoda.
         * Poziva se nakon svake promene filtera.
         */
        function filterProducts() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();
            const categoryFilter = document.getElementById("categoryFilter").value;
            const brandFilter = document.getElementById("brandFilter").value;
            const seriesFilter = document.getElementById("seriesFilter").value;
            const seriesSort = document.getElementById("seriesSort").value;

            let filteredProducts = allProductsData.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchInput);
                const matchesCategory = categoryFilter === "" || product.category === categoryFilter;
                const matchesBrand = brandFilter === "" || product.brand === brandFilter;
                const matchesSeries = seriesFilter === "" || product.series === seriesFilter;

                // Provera da li se podudara sa trenutnim filterom specifikacija
                const matchesSpecFilter = !currentSelectedSpecFilter.key || (
                    getNormalizedSpecifications(product)[currentSelectedSpecFilter.key] &&
                    getNormalizedSpecifications(product)[currentSelectedSpecFilter.key].toLowerCase().includes(currentSelectedSpecFilter.value.toLowerCase())
                );

                return matchesSearch && matchesCategory && matchesBrand && matchesSeries && matchesSpecFilter;
            });

            // Primeni sortiranje po seriji
            if (seriesSort === "asc") {
                filteredProducts.sort((a, b) => (a.series || "").localeCompare(b.series || ""));
            } else if (seriesSort === "desc") {
                filteredProducts.sort((a, b) => (b.series || "").localeCompare(a.series || ""));
            }

            renderProducts(filteredProducts);
        }

        /**
         * Dodaje event listener-e na filtere i input polje za pretragu.
         */
        function addEventListeners() {
            document.getElementById("searchInput").addEventListener("input", filterProducts);
            document.getElementById("categoryFilter").addEventListener("change", filterProducts);
            document.getElementById("brandFilter").addEventListener("change", filterProducts);
            document.getElementById("seriesFilter").addEventListener("change", filterProducts);
            document.getElementById("seriesSort").addEventListener("change", filterProducts);

            // Event delegation za klikabilne filtere u karticama proizvoda
            document.getElementById("products").addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('filter-brand')) {
                    document.getElementById("brandFilter").value = target.dataset.brand;
                    filterProducts();
                } else if (target.classList.contains('filter-category')) {
                    document.getElementById("categoryFilter").value = target.dataset.category;
                    filterProducts();
                } else if (target.classList.contains('filter-series')) {
                    document.getElementById("seriesFilter").value = target.dataset.series;
                    filterProducts();
                } else if (target.classList.contains('filter-spec')) {
                    currentSelectedSpecFilter = { key: target.dataset.specKey, value: decodeURIComponent(target.dataset.specValue) };
                    filterProducts();
                }
            });
        }

        /**
         * Funkcija koja se poziva kada se klikne na "Pročitaj više" u kartici proizvoda.
         * @param {string} productId - ID proizvoda čiji pregled želimo da prikažemo.
         */
        async function showProductOverviewModal(productId) {
            const modal = document.getElementById('productOverviewModal');
            const overviewContainer = document.getElementById('productOverviewContainer');
            const product = productIndex.get(productId);

            if (!product) {
                displayUIMessage("Proizvod nije pronađen.", "error", "productOverviewMessageArea");
                return;
            }

            // Prikazivanje modala
            modal.style.display = 'flex';
            document.getElementById('productOverviewTitle').textContent = `AI Recenzija za ${product.name}`;
            overviewContainer.innerHTML = `<h3>Generiranje AI recenzije...</h3><p>Ovo može potrajati.</p>`;
            overviewContainer.classList.add('loading');

            const normalizedSpecs = getNormalizedSpecifications(product);
            const specsForGemini = Object.entries(normalizedSpecs).map(([key, value]) => `${translationMap[key] || key}: ${value}`).join(', ');

            const prompt = `Analiziraj sljedeće specifikacije audio proizvoda i napiši detaljan, profesionalan pregled. Fokusiraj se na ključne karakteristike, kvalitetu, potencijalnu upotrebu i usporedi ga sa sličnim proizvodima na tržištu, koristeći samo dobivene informacije. Ako su specifikacije nejasne, navedi to. Odgovor napiši na hrvatskom jeziku, formatiran kao HTML paragrafi. Prikazane specifikacije su za model "${product.name}" brenda "${product.brand}".
            Specifikacije: ${JSON.stringify(product)}.
            Dugi opis: ${product.longDescription || 'Nema dugog opisa.'}
            Ključne specifikacije za analizu: ${specsForGemini}`;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas će automatski osigurati API ključ
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    overviewContainer.innerHTML = text;
                } else {
                    overviewContainer.innerHTML = `<p class="error-message">Nema rezultata recenzije od Geminija. Pokušajte ponovno.</p>`;
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                overviewContainer.innerHTML = `<p class="error-message">Došlo je do greške prilikom kontaktiranja AI asistenta. Molimo pokušajte ponovno.</p>`;
            } finally {
                overviewContainer.classList.remove('loading');
            }
        }


        /**
         * Funkcija koja se poziva kada se klikne na "AI Preporuka Proizvoda".
         * @param {string} productId - ID proizvoda za koji želimo preporuke.
         */
        async function showRecommendationModal(productId) {
            const modal = document.getElementById('recommendationModal');
            const recommendationContainer = document.getElementById('recommendationContainer');
            const product = productIndex.get(productId);

            if (!product) {
                displayUIMessage("Proizvod nije pronađen.", "error", "recommendationMessageArea");
                return;
            }

            modal.style.display = 'flex';
            document.getElementById('recommendationTitle').textContent = `AI Preporuka za ${product.name}`;
            recommendationContainer.innerHTML = `<h3>Generiranje AI preporuke...</h3><p>Ovo može potrajati.</p>`;
            recommendationContainer.classList.add('loading');

            const prompt = `Analiziraj sljedeće specifikacije audio proizvoda i preporuči 3-5 drugih proizvoda iz naše liste koji bi se dobro uklopili u sustav s ovim proizvodom, ili su slične klase. Preporučeni proizvodi ne smiju biti isti kao ovaj proizvod. Objasni zašto si odabrao baš te proizvode, uzimajući u obzir tehničke karakteristike poput snage, impedancije, dimenzija i namjene.
            Specifikacije proizvoda za koji se traži preporuka: ${JSON.stringify(product)}.
            Dostupni proizvodi za preporuku: ${JSON.stringify(allProductsData)}.
            Odgovor formatiraj kao HTML kod. Treba da sadrži naslov i listu preporučenih proizvoda, gdje je svaki proizvod prikazan u HTML kartici sa osnovnim informacijama (ime, brend, slika) i kratkim objašnjenjem zašto je preporučen. Svaka kartica treba da ima klasu 'recommended-product-card'.`;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas će automatski osigurati API ključ
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    recommendationContainer.innerHTML = text;
                } else {
                    recommendationContainer.innerHTML = `<p class="error-message">Nema rezultata preporuka od Geminija. Pokušajte ponovno.</p>`;
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                recommendationContainer.innerHTML = `<p class="error-message">Došlo je do greške prilikom kontaktiranja AI asistenta. Molimo pokušajte ponovno.</p>`;
            } finally {
                recommendationContainer.classList.remove('loading');
            }
        }


        /**
         * Funkcija koja otvara modal za upoređivanje proizvoda.
         */
        function showComparisonModal() {
            const modal = document.getElementById('comparisonModal');
            const comparisonTableContainer = document.getElementById('comparisonTableContainer');
            const messageArea = document.getElementById('comparisonMessageArea');
            const analyzeButton = document.getElementById('analyzeComparisonButton');
            const geminiAnalysisContainer = document.getElementById('geminiAnalysisContainer');

            // Resetuj prethodnu analizu
            geminiAnalysisContainer.innerHTML = '';
            geminiAnalysisContainer.classList.remove('loading');

            if (productsToCompare.length < 2) {
                displayUIMessage("Molimo odaberite najmanje 2 proizvoda za usporedbu.", "error", "comparisonMessageArea");
                return;
            }

            modal.style.display = 'flex';
            comparisonTableContainer.innerHTML = createComparisonTable(productsToCompare);
            messageArea.innerHTML = '';
            analyzeButton.disabled = false;
        }

        /**
         * Funkcija koja kreira HTML tabelu za usporedbu proizvoda.
         * @param {Array} products - Niz proizvoda za usporedbu.
         * @returns {string} HTML string tabele.
         */
        function createComparisonTable(products) {
            if (products.length === 0) {
                return '<p>Nema proizvoda za usporedbu.</p>';
            }

            // Sakupiti sve jedinstvene ključeve iz svih proizvoda i njihovih specifikacija
            const allUniqueKeys = new Set();
            products.forEach(p => {
                // Dodaj top-level ključeve (osim onih koje ne želimo prikazati ili su specifikacije)
                for (const key in p) {
                    if (p.hasOwnProperty(key) && !['id', 'longDescription', 'imageUrl', 'specifications'].includes(key)) {
                        allUniqueKeys.add(key);
                    }
                }
                // Dodaj sve ključeve iz specifications objekta
                const specs = getNormalizedSpecifications(p);
                for (const specKey in specs) {
                    allUniqueKeys.add(specKey);
                }
            });

            // Sortiraj ključeve abecedno, koristeći prevedene nazive za sortiranje
            const sortedKeys = Array.from(allUniqueKeys).sort((a, b) => {
                const translatedA = translationMap[a] || a.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const translatedB = translationMap[b] || b.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                return translatedA.localeCompare(translatedB);
            });

            let tableHtml = `<table id="comparisonTable"><thead><tr><th>Karakteristika</th>`;
            products.forEach(p => {
                tableHtml += `<th>${escapeHtml(p.brand)} ${escapeHtml(p.name)}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            sortedKeys.forEach(key => {
                const displayKey = translationMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                tableHtml += `<tr><td><strong>${displayKey}</strong></td>`;
                products.forEach(p => {
                    let value = p[key];
                    const specs = getNormalizedSpecifications(p);

                    // Prioritetno uzmi vrednost iz specifikacija ako postoji
                    if (specs.hasOwnProperty(key)) {
                        value = specs[key];
                    }

                    if (key === 'imageUrl') {
                        tableHtml += `<td><img src="${escapeHtml(value)}" alt="${escapeHtml(p.name)}" style="width:100px; height:auto;"></td>`;
                    } else if (key === 'price_usd') {
                        tableHtml += `<td>${escapeHtml(value || 'N/A')} USD</td>`;
                    } else if (Array.isArray(value)) {
                        tableHtml += `<td><ul>${value.map(item => {
                            if (typeof item === 'object' && item !== null) {
                                let objItemContent = '';
                                for (const subKey in item) {
                                    const translatedSubKey = translationMap[subKey] || subKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    objItemContent += `<strong>${translatedSubKey}:</strong> ${escapeHtml(String(item[subKey]))} `;
                                }
                                return `<li>${objItemContent}</li>`;
                            }
                            return `<li>${escapeHtml(String(item))}</li>`;
                        }).join('')}</ul></td>`;
                    } else if (typeof value === 'object' && value !== null) {
                        let objContent = '<ul>';
                        for (const subKey in value) {
                            const translatedSubKey = translationMap[subKey] || subKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            objContent += `<li><strong>${translatedSubKey}:</strong> ${escapeHtml(String(value[subKey]))}</li>`;
                        }
                        objContent += '</ul>';
                        tableHtml += `<td>${objContent}</td>`;
                    } else {
                        tableHtml += `<td>${escapeHtml(String(value) || 'N/A')}</td>`;
                    }
                });
                tableHtml += `</tr>`;
            });

            tableHtml += `</tbody></table>`;
            return tableHtml;
        }

        /**
         * Funkcija koja zatvara modal za upoređivanje proizvoda.
         */
        function closeComparisonModal() {
            document.getElementById('comparisonModal').style.display = 'none';
        }

        /**
         * Funkcija koja zatvara modal za pregled proizvoda.
         */
        function closeProductOverviewModal() {
            document.getElementById('productOverviewModal').style.display = 'none';
        }

        /**
         * Funkcija koja zatvara modal za preporuke proizvoda.
         */
        function closeRecommendationModal() {
            document.getElementById('recommendationModal').style.display = 'none';
        }

        /**
         * Funkcija koja otvara modal za AI asistenta za postavku sistema.
         */
        function showSetupAssistantModal() {
            const modal = document.getElementById('setupAssistantModal');
            const select = document.getElementById('selectProductForSetup');
            
            // Popuni select box sa svim pojačalima i AV receiverima
            select.innerHTML = '<option value="">Odaberite proizvod</option>';
            allProductsData.forEach(product => {
                // Proveri kategoriju i dodaj u select box
                if (product.category === 'Pojačala' || product.category === 'AV receiveri') {
                    const option = document.createElement('option');
                    option.value = `${encodeURIComponent(product.brand)}-${encodeURIComponent(product.name)}`;
                    option.textContent = `${product.brand} - ${product.name}`;
                    select.appendChild(option);
                }
            });

            modal.style.display = 'flex';
        }

        /**
         * Funkcija koja zatvara modal za AI asistenta za postavku sistema.
         */
        function closeSetupAssistantModal() {
            document.getElementById('setupAssistantModal').style.display = 'none';
            // Resetuj formu i savete
            document.getElementById('selectProductForSetup').value = '';
            document.getElementById('roomLength').value = '';
            document.getElementById('roomWidth').value = '';
            document.getElementById('roomHeight').value = '';
            document.getElementById('floorType').value = 'Hardwood';
            document.getElementById('furnitureDensity').value = 'Moderate';
            document.getElementById('listeningPreferences').value = '';
            document.getElementById('setupAdviceContainer').innerHTML = '';
        }

        /**
         * Funkcija koja generiše savet za postavku sistema koristeći Gemini.
         */
        async function generateSetupAdvice() {
            const setupAssistantMessageArea = document.getElementById("setupAssistantMessageArea");
            const setupAdviceContainer = document.getElementById("setupAdviceContainer");
            const generateButton = document.getElementById("generateSetupAdviceButton");

            const selectedProductId = document.getElementById("selectProductForSetup").value;
            const roomLength = parseFloat(document.getElementById("roomLength").value);
            const roomWidth = parseFloat(document.getElementById("roomWidth").value);
            const roomHeight = parseFloat(document.getElementById("roomHeight").value);
            const floorType = document.getElementById("floorType").value;
            const furnitureDensity = document.getElementById("furnitureDensity").value;
            const listeningPreferences = document.getElementById("listeningPreferences").value.trim();

            if (!selectedProductId || isNaN(roomLength) || isNaN(roomWidth) || isNaN(roomHeight) || roomLength <= 0 || roomWidth <= 0 || roomHeight <= 0) {
                displayUIMessage("Molimo popunite sva obavezna polja (proizvod i dimenzije sobe).", "error", "setupAssistantMessageArea");
                return;
            }

            const selectedProduct = productIndex.get(selectedProductId);
            if (!selectedProduct) {
                displayUIMessage("Odabrani proizvod nije pronađen.", "error", "setupAssistantMessageArea");
                return;
            }

            setupAdviceContainer.innerHTML = 'Generiranje savjeta...';
            setupAdviceContainer.classList.add('loading');
            generateButton.disabled = true;
            displayUIMessage("Generiranje savjeta za postavku sustava...", "info", "setupAssistantMessageArea");

            const amplifierSpecs = getNormalizedSpecifications(selectedProduct);
            const amplifierPower = getAmplifierOutputPower(amplifierSpecs);

            // Filtriraj zvučnike koji odgovaraju pojačalu
            const compatibleSpeakers = allProductsData.filter(product => {
                if (product.category !== 'Zvučnici') return false;

                const speakerSpecs = getNormalizedSpecifications(product);
                const speakerImpedance = parseImpedance(speakerSpecs["nominal_impedance"] || speakerSpecs["Impedansa"]);
                const speakerRecommendedPower = parsePowerRange(speakerSpecs["recommended_amplifier_power"] || speakerSpecs["Preporučena snaga pojačala"]);

                if (!speakerImpedance || !speakerRecommendedPower || !amplifierPower) {
                    return false;
                }

                // Provera impedanse
                const amplifierImpedanceRange = getAmplifierSupportedImpedanceRange(amplifierSpecs);
                const impedanceOverlap = doImpedanceRangesOverlap(amplifierImpedanceRange, toImpedanceRange(speakerImpedance.min)); // Može biti samo min vrednost zvučnika
                if (!impedanceOverlap) {
                    return false;
                }

                // Provera snage
                return amplifierPower >= speakerRecommendedPower.min && amplifierPower <= speakerRecommendedPower.max;
            });
            
            // Pripremi podatke za Gemini
            const compatibleSpeakersList = compatibleSpeakers.map(s => `${s.brand} ${s.name}`).join(', ') || 'Nema kompatibilnih zvučnika.';

            let prompt = `Kao AI asistent za audio postavke, pruži detaljan savjet za optimalnu postavku sljedećeg audio proizvoda u datoj prostoriji, uzimajući u obzir navedene preferencije. Fokusiraj se na pozicioniranje zvučnika (ako je relevantno), akustične savjete za prostoriju i osnovne smjernice za podešavanje ekvilizatora (ako je primjenjivo). Odgovori na hrvatskom jeziku i nemoj koristiti zvjezdice ili druge ukrasne znakove u odgovoru.\n\n`;

            prompt += `Detalji proizvoda:\n`;
            prompt += `  Naziv: ${selectedProduct.name}\n`;
            prompt += `  Brend: ${selectedProduct.brand}\n`;
            prompt += `  Kategorija: ${selectedProduct.category}\n`;
            prompt += `  Opis: ${selectedProduct.description}\n`;
            const rawSpecs = selectedProduct.specifications;
            if (Object.keys(rawSpecs).length > 0) {
                prompt += `  Specifikacije:\n`;
                for (const key in rawSpecs) {
                    const value = rawSpecs[key];
                    if (Array.isArray(value)) {
                        prompt += `    - ${translationMap[key] || key}: ${value.join(', ')}\n`;
                    } else if (typeof value === 'object' && value !== null) {
                        prompt += `    - ${translationMap[key] || key}:\n`;
                        for (const subKey in value) {
                            prompt += `      ${translationMap[subKey] || subKey}: ${value[subKey]}\n`;
                        }
                    } else {
                        prompt += `    - ${translationMap[key] || key}: ${value}\n`;
                    }
                }
            }
            prompt += `\n`;

            prompt += `Detalji prostorije:\n`;
            prompt += `  Duljina: ${roomLength} metara\n`;
            prompt += `  Širina: ${roomWidth} metara\n`;
            prompt += `  Visina: ${roomHeight} metara\n`;
            prompt += `  Tip poda: ${floorType}\n`;
            prompt += `  Gustina namještaja: ${furnitureDensity}\n`;
            prompt += `\n`;

            if (listeningPreferences) {
                prompt += `Preferencije slušanja: ${listeningPreferences}\n\n`;
            } else {
                prompt += `Preferencije slušanja: Nema specifičnih preferencija.\n\n`;
            }
            prompt += `Kompatibilni zvučnici: ${compatibleSpeakersList}\n\n`;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas će automatski osigurati API ključ
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    setupAdviceContainer.innerHTML = text;
                    displayUIMessage("Savjet za postavku je generiran.", "info", "setupAssistantMessageArea");
                } else {
                    setupAdviceContainer.innerHTML = 'Nema rezultata savjeta od Geminija. Pokušajte ponovno.';
                    displayUIMessage("Nema rezultata savjeta od Geminija. Pokušajte ponovno.", "error", "setupAssistantMessageArea");
                }
            } catch (error) {
                console.error("Greška pri pozivanju Gemini API-ja (asistent za postavku):", error);
                setupAdviceContainer.innerHTML = 'Došlo je do greške pri generiranju savjeta. Molimo pokušajte ponovno.';
                displayUIMessage("Došlo je do greške pri generiranju savjeta. Molimo pokušajte ponovno.", "error", "setupAssistantMessageArea");
            } finally {
                setupAdviceContainer.classList.remove('loading');
                generateButton.disabled = false;
            }
        }


        /**
         * Funkcija koja analizira usporedbu odabranih proizvoda koristeći Gemini.
         */
        async function analyzeComparisonWithGemini() {
            const container = document.getElementById('geminiAnalysisContainer');
            const analyzeButton = document.getElementById('analyzeComparisonButton');
            const comparisonProductsData = productsToCompare.map(p => {
                const specs = getNormalizedSpecifications(p);
                // Prevedi ključeve specifikacija za Gemini prompt
                const translatedSpecs = {};
                for (const key in specs) {
                    translatedSpecs[translationMap[key] || key] = specs[key];
                }

                return {
                    name: p.name,
                    brand: p.brand,
                    category: p.category,
                    price: p.price_usd,
                    specifications: translatedSpecs
                };
            });

            container.innerHTML = `<h3>Generiranje analize usporedbe...</h3><p>Ovo može potrajati.</p>`;
            container.classList.add('loading');
            analyzeButton.disabled = true;

            const prompt = `Usporedi sljedeće audio proizvode. Analiziraj njihove ključne specifikacije i karakteristike, istakni sličnosti i razlike, i pruži preporuku za potencijalnog kupca na temelju dobivenih podataka. Odgovor formatiraj kao HTML paragrafi na hrvatskom jeziku, koristeći podebljavanje i liste za bolju čitljivost.
            Podaci za usporedbu: ${JSON.stringify(comparisonProductsData)}`;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas će automatski osigurati API ključ
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    container.innerHTML = text;
                } else {
                    container.innerHTML = `<p class="error-message">Nema rezultata analize od Geminija. Pokušajte ponovno.</p>`;
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                container.innerHTML = `<p class="error-message">Došlo je do greške prilikom kontaktiranja AI asistenta. Molimo pokušajte ponovno.</p>`;
            } finally {
                container.classList.remove('loading');
                analyzeButton.disabled = false;
            }
        }
        
        /**
         * Funkcija koja se poziva kada se klikne na checkbox za usporedbu.
         * @param {Event} event - Objekat događaja.
         * @param {string} productId - ID proizvoda.
         */
        function handleComparisonCheckboxClick(event, productId) {
            const isChecked = event.target.checked;
            const product = productIndex.get(productId);
            const compareButton = document.getElementById('compareButton');
            const clearButton = document.getElementById('clearComparisonButton');
            const mainMessageArea = document.getElementById('mainMessageArea');

            if (isChecked) {
                if (productsToCompare.length >= MAX_PRODUCTS_TO_COMPARE) {
                    event.target.checked = false; // Opozovi čekiranje
                    displayUIMessage(`Možete usporediti najviše ${MAX_PRODUCTS_TO_COMPARE} proizvoda.`, "error", "mainMessageArea");
                    return;
                }
                if (product) {
                    productsToCompare.push(product);
                }
            } else {
                productsToCompare = productsToCompare.filter(p => p.id !== productId);
            }

            // Ažuriraj stanje dugmadi
            const count = productsToCompare.length;
            compareButton.textContent = `Usporedi (${count})`;
            compareButton.disabled = count < 2;
            clearButton.disabled = count === 0;

            if (count === 0) {
                mainMessageArea.innerHTML = '';
            }
        }

        /**
         * Funkcija za brisanje liste proizvoda za usporedbu.
         */
        function clearComparison() {
            productsToCompare = [];
            document.querySelectorAll('.compare-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            const compareButton = document.getElementById('compareButton');
            const clearButton = document.getElementById('clearComparisonButton');
            compareButton.textContent = `Usporedi (0)`;
            compareButton.disabled = true;
            clearButton.disabled = true;
            displayUIMessage("Lista za usporedbu je obrisana.", "info", "mainMessageArea");
        }

        // Inicijalno učitavanje podataka i postavljanje listenera
        document.addEventListener("DOMContentLoaded", () => {
            populateFilters();
            addEventListeners();
        });

        // Helper funkcija za HTML eskejpovanje
        function escapeHtml(unsafe) {
            if (unsafe == null || typeof unsafe !== 'string') {
                return ''; // Vraća prazan string ako je unsafe null ili undefined
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/`/g, "&#96;")
                .replace(/<\/script>/gi, "<\\/script>")
                .replace(/\n/g, "&#10;") // Escape newline
                .replace(/\r/g, "&#13;") // Escape carriage return
                .replace(/\\/g, "&#92;"); // Escape backslash
        }
    </script>
</body>
</html>
