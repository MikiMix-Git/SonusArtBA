<!DOCTYPE html>
<!--
CHANGELOG
v0.13.7 (2025-08-13)
- Ispravljeno: Svojstvo 'link' se više ne prikazuje kao "Id:" na kartici proizvoda.
- Dodano svojstvo 'link' na listu ključeva koji se ignoriraju tokom renderiranja.
-->
<html lang="hr">
<head>
<meta charset="UTF-8">
<title>Argon & Marantz Katalog</title>
<style>
:root {
  --bg:#f4f4f4; --ink:#222; --ink-soft:#444; --ink-muted:#666; --card:#fff;
  --accent:#007acc; --accent-hover:#005c99; --ok:#155724; --ok-bg:#d4edda;
  --bad:#721c24; --bad-bg:#f8d7da; --line:#ccc; --soft:#eee;
}
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; color: var(--ink); }
header { background: var(--ink); color: #fff; padding: 1rem; text-align: center; }
.sticky-bar { position: sticky; top: 0; z-index: 10; }
nav, .filters { background: var(--ink-soft); padding: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
nav button, .filters input, .filters select, .filters button { padding: 0.5rem; border-radius: 4px; border: none; }
nav button { background: var(--ink-muted); color: white; cursor: pointer; }
nav button.active { background: var(--accent); }
nav button:hover { background: #999; }
.filters input[type="number"] { width: 90px; }
.filters button { background: var(--accent); color: #fff; cursor: pointer; }
.filters button:hover { background: var(--accent-hover); }
.catalog-header { padding: 0.5rem 1rem; font-weight: bold; background: var(--soft); }
.catalog { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap: 1rem; padding: 1rem; }
.product-card { background: var(--card); border-radius: 6px; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.product-card img { max-width: 100%; height: auto; border-radius: 4px; background: #fafafa; object-fit: cover; }
.product-card h3 { margin: 0.6rem 0 0.2rem; font-size: 1.05rem; }
.product-card p { margin: 0.2rem 0; }
.badges { font-size: 0.92em; margin-top: 0.5rem; padding-left: 1.1rem; }
.badges li { margin: 0.15rem 0; }
.specs dl { margin: 0; padding: 0; }
.specs dt { font-weight: bold; margin-top: 0.5rem; }
.specs dd { margin-left: 1em; }
@media (max-width: 600px) {
  .filters { flex-direction: column; }
  nav { flex-direction: column; }
}
</style>
</head>
<body>

<header>
  <h1>Argon & Marantz – Katalog proizvoda 
    <span id="version-badge" style="font-size:.75em; background:#222; color:#fff; padding:.2em .5em; border-radius:4px;">v0.13.7</span>
  </h1>
</header>

<div class="sticky-bar">
  <nav id="category-nav"></nav>
  <div class="filters">
    <select id="brand-filter">
      <option value="ALL">Svi brendovi</option>
      <option value="Argon">Argon</option>
      <option value="Marantz">Marantz</option>
    </select>
    <input type="text" id="search" placeholder="Pretraga po nazivu...">
    <input type="number" id="min-price" placeholder="Min €">
    <input type="number" id="max-price" placeholder="Max €">
    <select id="feature-filter">
      <option value="">Sve karakteristike</option>
      <option value="Bluetooth">Bluetooth</option>
      <option value="Wi-Fi">Wi‑Fi</option>
      <option value="HDMI ARC">HDMI ARC</option>
      <option value="ANC">ANC</option>
    </select>
    <select id="sort-select">
      <option value="">Bez sortiranja</option>
      <option value="price-asc">Cijena ↑</option>
      <option value="price-desc">Cijena ↓</option>
      <option value="rating-desc">Ocjena ↓</option>
      <option value="rating-asc">Ocjena ↑</option>
    </select>
    <label><input type="checkbox" id="only-priced"> Samo sa cijenom</label>
    <button id="apply-btn">Primijeni filtere</button>
  </div>
</div>

<div class="catalog-header" id="catalog-count"></div>
<section class="catalog" id="product-list"></section>

<script>
const APP_VERSION = "0.13.7";
const RAW_ARGON = "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/main/json/argon_audio_products_all_categories.json";
const RAW_MARANTZ = "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/json/marantz_all_products.json";
let allProducts = {};
let allItemsFlat = [];
let currentBrand = "ALL";
let currentCategory = "ALL";

function normalizePrice(val) {
  if (typeof val !== "string") return Number(val) || 0;
  const compact = val.replace(/\s/g, "");
  const match = compact.match(/(\d+[.,]?\d*)/g);
  if (!match) return 0;
  let s = match[match.length - 1];
  if (s.includes(".") && s.includes(",")) s = s.replace(/\./g, "").replace(",", ".");
  else if (s.includes(",")) s = s.replace(",", ".");
  return parseFloat(s) || 0;
}
function renderBadges(badges = []) {
  return badges.map(b => {
    const t = String(b).trim();
    if (/^\d+(\.\d+)?$/.test(t) && parseFloat(t) <= 5) {
      const rating = parseFloat(t), full = Math.floor(rating), half = (rating % 1) >= 0.5 ? 1 : 0, empty = 5 - full - half;
      return `<li title="Ocjena ${rating}">${"★".repeat(full) + (half ? "☆" : "") + "☆".repeat(empty)} (${rating})</li>`;
    }
    return `<li>${b}</li>`;
  }).join("");
}
function getRatingFromBadges(prod) {
  const b = (prod["badge-ovi"] || prod["bedz"] || []).find(x => /^\d+(\.\d+)?$/.test(String(x).trim()));
  return b ? parseFloat(b) : 0;
}
function dedupProducts(items) {
  const map = new Map();
  items.forEach(p => {
    const key = `${p.naziv || ""}|${p.link || ""}`;
    if (!map.has(key)) map.set(key, p);
  });
  return Array.from(map.values());
}

Promise.all([
  fetch(RAW_ARGON).then(r => r.json()),
  fetch(RAW_MARANTZ).then(r => r.json())
]).then(([argonData, marantzData]) => {
  allProducts = {
    Argon: argonData,
    Marantz: marantzData
  };

  const processedMarantz = marantzData.map(p => {
    let imageUrl = p.image;
    // Provjera i ispravljanje dupliranog domena u URL-u slike
    if (imageUrl && imageUrl.startsWith('https://www.marantz.comhttps://www.marantz.com')) {
        imageUrl = imageUrl.replace('https://www.marantz.comhttps://www.marantz.com', 'https://www.marantz.com');
    }
    return {
      ...p,
      brend: "Marantz",
      naziv: p.name,
      cijena: p.price,
      opis: p.tagline,
      slika_url: (imageUrl && imageUrl.trim() !== '') ? imageUrl : null,
      "badge-ovi": (p.features || []).map(f => f.title)
    };
  });
  
  allItemsFlat = dedupProducts([
    ...Object.values(argonData).flat().map(p => ({ ...p, brend: "Argon" })),
    ...processedMarantz
  ]);

  renderCategoriesForBrand("ALL");
  highlightActiveCategory();
  applyFilters();
  document.getElementById("version-badge").textContent = `v${APP_VERSION}`;
  document.title = `Katalog v${APP_VERSION}`;
});

function renderCategoriesForBrand(brand) {
    const nav = document.getElementById("category-nav");
    nav.innerHTML = "";
    let categories = ["ALL"];
    if (brand === "Argon") {
        categories = ["ALL", ...Object.keys(allProducts.Argon)];
    }
    categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat === "ALL" ? `Sve kategorije` : cat;
        btn.dataset.cat = cat;
        btn.onclick = () => {
            currentCategory = cat;
            highlightActiveCategory();
            applyFilters();
        };
        nav.appendChild(btn);
    });
}

function highlightActiveCategory() {
  document.querySelectorAll("#category-nav button")
    .forEach(b => b.classList.toggle("active", b.dataset.cat === currentCategory));
}

function sourceItems() {
  const brand = currentBrand;
  const cat = currentCategory;
  if (brand === "ALL") {
    return allItemsFlat;
  }
  if (brand === "Argon") {
    if (cat === "ALL") {
      return Object.values(allProducts.Argon).flat().map(p => ({ ...p, brend: "Argon" }));
    }
    return (allProducts.Argon?.[cat] || []).map(p => ({ ...p, brend: "Argon" }));
  }
  if (brand === "Marantz") {
    return allProducts.Marantz.map(p => {
      let imageUrl = p.image;
      if (imageUrl && imageUrl.startsWith('https://www.marantz.comhttps://www.marantz.com')) {
          imageUrl = imageUrl.replace('https://www.marantz.comhttps://www.marantz.com', 'https://www.marantz.com');
      }
      return {
        ...p,
        brend: "Marantz",
        naziv: p.name,
        cijena: p.price,
        opis: p.tagline,
        slika_url: (imageUrl && imageUrl.trim() !== '') ? imageUrl : null,
        "badge-ovi": (p.features || []).map(f => f.title)
      };
    });
  }
  return [];
}
function applySort(items) {
  switch (document.getElementById("sort-select").value) {
    case "price-asc":  return items.slice().sort((a,b)=> normalizePrice(a.cijena) - normalizePrice(b.cijena));
    case "price-desc": return items.slice().sort((a,b)=> normalizePrice(b.cijena) - normalizePrice(a.cijena));
    case "rating-desc":return items.slice().sort((a,b)=> getRatingFromBadges(b) - getRatingFromBadges(a));
    case "rating-asc": return items.slice().sort((a,b)=> getRatingFromBadges(a) - getRatingFromBadges(b));
    default: return items;
  }
}
function renderList(items) {
  const list = document.getElementById("product-list");
  list.innerHTML = "";
  document.getElementById("catalog-count").textContent = 
    `${currentBrand === "ALL" ? "Svi brendovi" : currentBrand} – ${currentCategory === "ALL" ? "sve kategorije" : currentCategory} – ${items.length} artikala`;

  items.forEach(prod => {
    const card = document.createElement("div");
    card.className = "product-card";

    let cardContent = `
      <img src="${prod.slika_url || "https://via.placeholder.com/300x200?text=Bez+slike"}" alt="${prod.naziv}">
      <h3>${prod.naziv || 'Nepoznat naziv'}</h3>
      <p>${prod.opis || prod.tagline || ''}</p>
      <p><strong>Cijena:</strong> ${prod.cijena || '-'}</p>
      <div class="specs">
    `;

    for (const key in prod) {
      if (prod.hasOwnProperty(key)) {
        if (key === "slika_url" || key === "naziv" || key === "opis" || key === "tagline" || key === "cijena" || key === "bedz" || key === "badge-ovi" || key === "link" || key === "image" || key === "name" || key === "price" || key === "features" || key === "brend" || key === "id") {
          // Ovi ključevi su već obrađeni ili se ne prikazuju.
          continue;
        }

        const value = prod[key];
        if (typeof value === 'object' && value !== null) {
          if (key === "specifikacije") {
            cardContent += `<h4>Specifikacije</h4><dl>`;
            for (const specKey in value) {
              cardContent += `<dt>${specKey}</dt><dd>${value[specKey]}</dd>`;
            }
            cardContent += `</dl>`;
          }
        } else {
          cardContent += `<h4>${key.charAt(0).toUpperCase() + key.slice(1)}:</h4><p>${value}</p>`;
        }
      }
    }
    
    const badgeList = prod["badge-ovi"] || prod["bedz"] || [];
    if (badgeList.length) {
      cardContent += `<h4>Karakteristike</h4><ul class="badges">${renderBadges(badgeList)}</ul>`;
    }

    cardContent += `</div>`;
    card.innerHTML = cardContent;
    list.appendChild(card);
  });
}

function applyFilters() {
  currentBrand = document.getElementById("brand-filter").value;
  const searchVal = document.getElementById("search").value.toLowerCase();
  const minPrice = parseFloat(document.getElementById("min-price").value) || 0;
  const maxPrice = parseFloat(document.getElementById("max-price").value) || Infinity;
  const feature = document.getElementById("feature-filter").value.trim().toLowerCase();
  const onlyPriced = document.getElementById("only-priced").checked;

  let items = sourceItems().filter(p => {
    const nameMatch = (p.naziv || "").toLowerCase().includes(searchVal);
    const priceVal = normalizePrice(p.cijena);
    const priceMatch = priceVal >= minPrice && priceVal <= maxPrice;
    const hasPrice = p.cijena && p.cijena !== "N/A";

    const badges = (p["badge-ovi"] || p["bedz"] || []).map(b => String(b).toLowerCase());
    const specsVals = p.specifikacije ? Object.values(p.specifikacije).map(v => String(v).toLowerCase()) : [];

    const featureMatch = !feature || badges.some(b => b.includes(feature)) || specsVals.some(v => v.includes(feature));
    return nameMatch && priceMatch && featureMatch && (!onlyPriced || hasPrice);
  });

  items = applySort(items);
  renderList(items);
}

document.getElementById("apply-btn").addEventListener("click", applyFilters);
document.getElementById("sort-select").addEventListener("change", applyFilters);
document.getElementById("feature-filter").addEventListener("change", applyFilters);
document.getElementById("only-priced").addEventListener("change", applyFilters);

document.getElementById("brand-filter").addEventListener("change", (e) => {
    currentBrand = e.target.value;
    currentCategory = "ALL";
    renderCategoriesForBrand(currentBrand);
    highlightActiveCategory();
    applyFilters();
});

["search", "min-price", "max-price"].forEach(id => {
  document.getElementById(id).addEventListener("keydown", e => { if (e.key === "Enter") applyFilters(); });
});
</script>

</body>
</html>
