<!DOCTYPE html>
<!--
CHANGELOG
v0.44.9 (2025-08-18)
- Ispravljeno: Greška TypeError: Cannot read properties of undefined (reading '0')
- Dodano: Provjera za 'categories' polje prije pristupa, te dodjeljivanje 'Nekategorisano' ako ne postoji.
-->
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Argon & Marantz Katalog - Firestore</title>
<style>
:root {
  --bg: #fff; /* Postavlja bijelu pozadinu */
  --ink:#222; --ink-soft:#444; --ink-muted:#666; --card:#fff;
  --accent:#007acc; --accent-hover:#005c99; --ok:#155724; --ok-bg:#d4edda;
  --bad:#721c24; --bad-bg:#f8d7da; --line:#ccc; --soft:#eee;
}
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; color: var(--ink); }
header { background: var(--ink); color: #fff; padding: 1rem; text-align: center; }
.sticky-bar { position: sticky; top: 0; z-index: 10; }
nav, .filters { background: var(--ink-soft); padding: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
nav button, .filters input, .filters select, .filters button { padding: 0.5rem; border-radius: 4px; border: none; }
nav button { background: var(--ink-muted); color: white; cursor: pointer; }
nav button.active { background: var(--accent); }
nav button:hover { background: #999; }
.filters input[type="number"] { width: 90px; }
.filters button { background: var(--accent); color: #fff; cursor: pointer; }
.filters button:hover { background: var(--accent-hover); }
.currency-toggle {
    display: flex;
    gap: 0.2rem;
}
.currency-button {
    padding: 0.5rem 0.7rem;
    background: var(--ink-muted);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.currency-button.active {
    background: var(--accent);
}
.currency-button:hover:not(.active) {
    background: #999;
}
.catalog-header { padding: 0.5rem 1rem; font-weight: bold; background: var(--soft); }
.catalog { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; padding: 1rem; }
.product-card { background: var(--card); border-radius: 6px; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
/* Image Gallery Styles */
.image-gallery { position: relative; width: 100%; margin-bottom: 1rem; }
.main-image-container { position: relative; width: 100%; padding-top: 66.66%; /* 3:2 Aspect Ratio */ background: #fafafa; border-radius: 4px; overflow: hidden; cursor: pointer; }
.main-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; transition: opacity 0.3s ease; }
.gallery-nav-btn {
  position: absolute; top: 50%; transform: translateY(-50%);
  background: rgba(0,0,0,0.5); color: white; border: none;
  font-size: 1.5rem; padding: 0.5rem; cursor: pointer; z-index: 5;
  border-radius: 50%; transition: background-color 0.2s;
}
.gallery-nav-btn:hover { background: rgba(0,0,0,0.8); }
.gallery-nav-btn.prev { left: 0.5rem; }
.gallery-nav-btn.next { right: 0.5rem; }
.thumbnails {
  display: flex; gap: 0.5rem; overflow-x: auto; padding-top: 0.5rem;
  white-space: nowrap;
}
.thumbnail {
  width: 60px; height: 60px; object-fit: cover; cursor: pointer;
  border: 2px solid transparent; border-radius: 4px; transition: border-color 0.2s;
}
.thumbnail.active { border-color: var(--accent); }

.product-card h3 { margin: 0.6rem 0 0.2rem; font-size: 1.1rem; }
.product-card p { margin: 0.2rem 0; }
.product-card h4 {
    margin-top: 1.2rem;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid var(--line);
    padding-bottom: 0.3rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    color: var(--ink-soft);
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px;
}
.product-card h4::after {
    content: '▼';
    position: absolute;
    right: 0;
    top: 0;
    font-size: 0.8rem;
    line-height: 1.2;
    transform: rotate(-90deg);
    transition: transform 0.3s ease;
}
.product-card h4.expanded::after {
    transform: rotate(0deg);
}
.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.collapsible-content.expanded {
    max-height: 1000px; /* Dovoljno velika vrijednost */
}
/* Updated 'link-button' styles */
.link-button {
  display: inline-block;
  background: transparent;
  color: var(--ink);
  border: 1px solid var(--ink);
  padding: 0.6rem 1rem;
  text-decoration: none;
  border-radius: 4px;
  text-align: center;
  margin-top: auto; /* Moves button to the bottom of the card */
  transition: all 0.2s ease-in-out;
  width: 100%;
}
.link-button:hover {
  background: var(--ink);
  color: #fff;
}
.features-list, .specs-list { padding-left: 0; list-style: none; }
.features-list li { margin-bottom: 0.5rem; }
.specs-list dt { font-weight: bold; color: var(--ink-muted); margin-top: 0.6rem; }
.specs-list dd { margin-left: 1em; margin-bottom: 0.2rem; word-wrap: break-word; }
.specs pre { white-space: pre-wrap; word-break: break-all; background: #f0f0f0; padding: 5px; border-radius: 3px; font-size: 0.9em; }
.rating-stars { color: gold; font-size: 1.1em; margin-left: 0.5em; }
.color-swatch-list {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
    padding: 0;
    list-style: none;
}
.color-swatch-list li {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}
.color-swatch {
    width: 20px;
    height: 20px;
    border: 1px solid var(--line);
    border-radius: 4px;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    cursor: pointer; /* Add pointer cursor for clicking */
}
/* Updated styles for brand logo */
.brand-logo {
    display: block;
    max-height: 25px; /* Smaller height for logos */
    margin-bottom: 0.5rem;
}
.invert-logo {
    filter: invert(1);
}
@media (max-width: 600px) {
  .filters { flex-direction: column; }
  nav { flex-direction: column; }
}

/* Styles for fullscreen view */
#fullscreen-modal {
  position: fixed;
  z-index: 100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
}
#modal-image {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
}
#modal-close-btn {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  transition: 0.3s;
  cursor: pointer;
}
#modal-close-btn:hover,
#modal-close-btn:focus {
  color: #bbb;
  text-decoration: none;
  cursor: pointer;
}
#modal-prev-btn, #modal-next-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  font-size: 2rem;
  padding: 0.5rem 1rem;
  cursor: pointer;
  z-index: 101;
  user-select: none;
}
#modal-prev-btn { left: 15px; }
#modal-next-btn { right: 15px; }
#modal-prev-btn:hover, #modal-next-btn:hover { background: rgba(0,0,0,0.8); }

/* Message box styles */
.message-box {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: white;
  border: 1px solid var(--line);
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  z-index: 1000;
  text-align: center;
  display: none;
}
.message-box button {
  margin-top: 10px;
  padding: 8px 16px;
  background-color: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
</style>
</head>
<body>

<header>
  <h1>Argon & Marantz – Katalog proizvoda 
    <span id="version-badge" style="font-size:.75em; background:#222; color:#fff; padding:.2em .5em; border-radius:4px;">v0.44.9</span>
  </h1>
</header>

<div class="sticky-bar">
  <nav id="category-nav"></nav>
  <div class="filters">
    <select id="brand-filter">
      <option value="ALL">Svi brendovi</option>
      <option value="Argon">Argon</option>
      <option value="Marantz">Marantz</option>
    </select>
    <input type="text" id="search" placeholder="Pretraga po nazivu...">
    <input type="number" id="min-price" placeholder="Min €">
    <input type="number" id="max-price" placeholder="Max €">
    <select id="feature-filter">
      <option value="">Sve karakteristike</option>
      <option value="Bluetooth">Bluetooth</option>
      <option value="Wi-Fi">Wi‑Fi</option>
      <option value="HDMI ARC">HDMI ARC</option>
    </select>
    <select id="sort-select">
      <option value="">Bez sortiranja</option>
      <option value="price-asc">Cijena ↑</option>
      <option value="price-desc">Cijena ↓</option>
      <option value="rating-desc">Ocjena ↓</option>
      <option value="rating-asc">Ocjena ↑</option>
    </select>
    <label><input type="checkbox" id="only-priced"> Samo sa cijenom</label>
    <button id="apply-btn">Primijeni filtere</button>
    <div class="currency-toggle">
        <button id="currency-eur" class="currency-button active">€</button>
        <button id="currency-km" class="currency-button">KM</button>
    </div>
  </div>
</div>

<!-- Add a button to load data -->
<div style="padding: 1rem; text-align: center;">
  <button id="load-data-btn" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Učitaj podatke u Firestore</button>
</div>

<div class="catalog-header" id="catalog-count"></div>
<section class="catalog" id="product-list"></section>

<!-- Fullscreen Image Modal -->
<div id="fullscreen-modal" style="display: none;">
  <span id="modal-close-btn">&times;</span>
  <img id="modal-image" src="" alt="Slika proizvoda u punoj veličini">
  <button id="modal-prev-btn" style="display: none;">‹</button>
  <button id="modal-next-btn" style="display: none;">›</button>
</div>

<!-- Message Box -->
<div id="message-box" class="message-box">
  <p id="message-text"></p>
  <button onclick="document.getElementById('message-box').style.display='none';">OK</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const APP_VERSION = "0.44.9";
const RAW_ARGON = "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/json/argon_audio_products_all_categories.json";
const RAW_MARANTZ = "https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/refs/heads/main/json/marantz_all_products.json";
const KM_CONVERSION_RATE = 1.95583;
const USD_TO_EUR_RATE = 0.93;

let allProducts = {};
let allItemsFlat = [];
let currentBrand = "ALL";
let currentCategory = "ALL";
let currentCurrency = 'EUR';

// Global variables for modal image
let modalImageUrls = [];
let modalImageIndex = 0;

// Firebase variables
let db, auth, userId;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

// Show message box
function showMessage(text) {
    document.getElementById('message-text').textContent = text;
    document.getElementById('message-box').style.display = 'block';
}

/**
 * Normalizes a price string to a number.
 * Specifically handles American and European price formats.
 * @param {string | number} val The price to normalize.
 * @returns {number} The normalized price as a number.
 */
function normalizePrice(val) {
  if (typeof val !== "string") return Number(val) || 0;
  
  // Remove all non-numeric characters, commas, or periods, including currency symbols
  let cleanedVal = val.replace(/[^\d.,]/g, '').trim();

  // Find the last comma and period
  const lastCommaIndex = cleanedVal.lastIndexOf(',');
  const lastDotIndex = cleanedVal.lastIndexOf('.');

  // If the last separator is a period (American format, e.g., 1,999.00)
  if (lastDotIndex > lastCommaIndex) {
      cleanedVal = cleanedVal.replace(/,/g, ''); // Remove all commas
  }
  // If the last separator is a comma (European format, e.g., 1.999,00)
  else if (lastCommaIndex > lastDotIndex) {
      cleanedVal = cleanedVal.replace(/\./g, ''); // Remove all periods
      cleanedVal = cleanedVal.replace(',', '.'); // Replace the comma with a period
  }
  
  return parseFloat(cleanedVal) || 0;
}
/**
 * Gets the rating from the product's badges.
 * @param {object} prod The product object.
 * @returns {number} The rating.
 */
function getRatingFromBadges(prod) {
  const badges = prod["badge-ovi"] || prod["bedz"] || prod["features"] || [];
  const ratingBadge = badges.find(b => {
      const val = typeof b === 'object' ? b.title : b;
      return /^\d+(\.\d+)?$/.test(String(val).trim());
  });
  if (ratingBadge) {
      const val = typeof ratingBadge === 'object' ? ratingBadge.title : ratingBadge;
      return parseFloat(val);
  }
  return 0;
}
/**
 * Renders category buttons for a specific brand.
 * @param {string} brand The brand name.
 */
function renderCategoriesForBrand(brand) {
    const nav = document.getElementById("category-nav");
    nav.innerHTML = "";
    let categories = ["ALL"];
    if (brand === "Argon" && allProducts.Argon) {
        categories = ["ALL", ...Object.keys(allProducts.Argon.categories)];
    } else if (brand === "Marantz" && allProducts.Marantz) {
        // Collect all categories for Marantz
        const marantzCategories = new Set(allItemsFlat.filter(p => p.brend === "Marantz" && p.categories).flatMap(p => p.categories));
        categories = ["ALL", ...Array.from(marantzCategories)];
    }
    categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat === "ALL" ? `Sve kategorije` : cat;
        btn.dataset.cat = cat;
        btn.onclick = () => {
            currentCategory = cat;
            highlightActiveCategory();
            applyFilters();
        };
        nav.appendChild(btn);
    });
}
/**
 * Highlights the active category button.
 */
function highlightActiveCategory() {
  document.querySelectorAll("#category-nav button")
    .forEach(b => b.classList.toggle("active", b.dataset.cat === currentCategory));
}
/**
 * Gets the list of items based on the current brand and category.
 * @returns {Array<object>} The filtered list of items.
 */
function sourceItems() {
  const brand = currentBrand;
  const cat = currentCategory;
  if (brand === "ALL") {
    return allItemsFlat;
  }
  if (brand === "Argon") {
    if (cat === "ALL") {
      const items = Object.values(allProducts.Argon?.categories || {}).flat();
      return items.map(p => ({
        ...p,
        brend: "Argon",
      }));
    }
    return (allProducts.Argon?.categories?.[cat] || []).map(p => ({
      ...p,
      brend: "Argon",
    }));
  }
  if (brand === "Marantz") {
    return allItemsFlat.filter(p => p.brend === "Marantz" && (cat === "ALL" || (p.categories && p.categories.includes(cat))));
  }
  return [];
}
/**
 * Applies all filters and updates the product list.
 */
function applyFilters() {
  let items = sourceItems();
  const searchInput = document.getElementById("search").value.toLowerCase();
  const minPrice = parseFloat(document.getElementById("min-price").value) || 0;
  const maxPrice = parseFloat(document.getElementById("max-price").value) || Infinity;
  const featureFilter = document.getElementById("feature-filter").value.toLowerCase();
  const onlyPriced = document.getElementById("only-priced").checked;

  items = items.filter(p => {
    const name = (p.naziv || p.name || '').toLowerCase();
    const normalizedPrice = normalizePrice(p.cijena || p.price);
    const badges = (p["badge-ovi"] || p["bedz"] || p.features || []).map(b => (typeof b === 'object' ? b.title : b).toLowerCase());
    const hasPrice = normalizedPrice > 0;
    
    return (!searchInput || name.includes(searchInput)) &&
           (normalizedPrice >= minPrice && normalizedPrice <= maxPrice) &&
           (!featureFilter || badges.includes(featureFilter)) &&
           (!onlyPriced || hasPrice);
  });
  
  items = applySort(items);
  renderList(items);
  updatePrices();
}
/**
 * Applies sorting to the list of items.
 * @param {Array<object>} items The list of items to sort.
 * @returns {Array<object>} The sorted list.
 */
function applySort(items) {
  switch (document.getElementById("sort-select").value) {
    case "price-asc":  return items.slice().sort((a,b)=> normalizePrice(a.cijena || a.price) - normalizePrice(b.cijena || b.price));
    case "price-desc": return items.slice().sort((a,b)=> normalizePrice(b.cijena || b.price) - normalizePrice(a.cijena || a.price));
    case "rating-desc":return items.slice().sort((a,b)=> getRatingFromBadges(b) - getRatingFromBadges(a));
    case "rating-asc": return items.slice().sort((a,b)=> getRatingFromBadges(a) - getRatingFromBadges(b));
    default: return items;
  }
}
/**
 * Renders star ratings based on a rating value.
 * @param {number} rating The rating value.
 * @returns {string} HTML string for the stars.
 */
function renderStars(rating) {
  if (!rating) return '';
  const full = Math.floor(rating);
  const half = (rating % 1) >= 0.5 ? 1 : 0;
  const empty = 5 - full - half;
  const stars = '★'.repeat(full) + (half ? '☆' : '') + '☆'.repeat(empty);
  return `<span class="rating-stars" title="Ocjena ${rating}">${stars} (${rating})</span>`;
}
/**
 * Renders the list of products.
 * @param {Array<object>} items The list of products to render.
 */
function renderList(items) {
  const list = document.getElementById("product-list");
  list.innerHTML = "";
  document.getElementById("catalog-count").textContent = 
    `${currentBrand === "ALL" ? "Svi brendovi" : currentBrand} – ${currentCategory === "ALL" ? "sve kategorije" : currentCategory} – ${items.length} artikala`;

  items.forEach((prod, index) => {
    const card = document.createElement("div");
    card.className = "product-card";
    const cardId = `card-${index}`;

    // Updated list of keys not to be displayed as 'other data'
    const processedKeys = new Set(['slika_url', 'image', 'images', 'naziv', 'name', 'opis', 'tagline', 'description', 'cijena', 'price', 'eur_price', 'link', 'specifications', 'features', 'badge-ovi', 'bedz', 'brend', 'id', 'categories', 'specifikacije', 'boje', 'images_urls', 'variants', 'brand_logo']);
    let cardContent = '';

    const imageUrls = prod.images_urls ? prod.images_urls.filter(Boolean) : [];
    const mainImageUrl = imageUrls[0] || 'https://placehold.co/300x200/cccccc/000000?text=Bez+slike';
    
    cardContent += `<div class="image-gallery" id="gallery-${cardId}">`;
    cardContent += `<div class="main-image-container">`;
    cardContent += `<img src="${mainImageUrl}" alt="Slika za ${prod.naziv || prod.name}" class="main-image" onerror="console.error('Slika se nije uspjela učitati:', this.src)">`;
    
    // Display gallery only if there is more than one image
    if (imageUrls.length > 1) {
      cardContent += `<button class="gallery-nav-btn prev">‹</button>`;
      cardContent += `<button class="gallery-nav-btn next">›</button>`;
      cardContent += `</div>`; // closes main-image-container
      cardContent += `<div class="thumbnails">`;
      imageUrls.forEach((url, i) => {
        cardContent += `<img src="${url}" alt="Sličica ${i+1}" class="thumbnail ${i === 0 ? 'active' : ''}" data-index="${i}" onerror="console.error('Sličica se nije uspjela učitati:', this.src)">`;
      });
      cardContent += `</div>`;
    } else {
        cardContent += `</div>`; // closes main-image-container
    }
    cardContent += `</div>`;

    let brandLogoHtml = '';
    if (prod.brand_logo) {
        const invertClass = (prod.brend === 'Argon') ? 'invert-logo' : '';
        brandLogoHtml = `<img src="${prod.brand_logo}" alt="${prod.brend || 'Brand'} Logo" class="brand-logo ${invertClass}">`;
    }
    cardContent += brandLogoHtml;
    
    const rating = getRatingFromBadges(prod);
    const ratingHtml = renderStars(rating);
    cardContent += `<h3>${prod.naziv || prod.name || 'Nepoznat naziv'}${ratingHtml}</h3>`;
    
    cardContent += `<p>${prod.opis || prod.tagline || prod.description || ''}</p>`;
    
    const normalizedPrice = prod.eur_price; // Use the already converted price
    if (normalizedPrice > 0) {
        cardContent += `<p><strong>Cijena:</strong> <span class="product-price" data-eur-price="${normalizedPrice}"></span></p>`;
    } else {
        cardContent += `<p><strong>Cijena:</strong> -</p>`;
    }

    const features = prod.features || prod['badge-ovi'] || prod['bedz'];
    if (features && features.length > 0) {
        const filteredFeatures = features.filter(f => {
            const val = typeof f === 'object' ? f.title : f;
            return !/^\d+(\.\d+)?$/.test(String(val).trim());
        });
        if (filteredFeatures.length > 0) {
            const featuresId = `features-${cardId}`;
            cardContent += `<h4 onclick="document.getElementById('${featuresId}').classList.toggle('expanded'); this.classList.toggle('expanded');">Karakteristike</h4>
                            <div id="${featuresId}" class="collapsible-content">
                                <ul class="features-list">`;
            filteredFeatures.forEach(feature => {
                if (typeof feature === 'object' && feature.title) {
                    cardContent += `<li><strong>${feature.title}:</strong> ${feature.description}</li>`;
                } else {
                    cardContent += `<li>${feature}</li>`;
                }
            });
            cardContent += `</ul></div>`;
        }
    }

    const specifications = prod.specifications || prod.specifikacije;
    if (specifications && typeof specifications === 'object') {
        const specId = `specs-${cardId}`;
        cardContent += `<h4 onclick="document.getElementById('${specId}').classList.toggle('expanded'); this.classList.toggle('expanded');">Specifikacije</h4>
                        <div id="${specId}" class="collapsible-content">
                            <dl class="specs-list">`;
        for (const specKey in specifications) {
            cardContent += `<dt>${specKey}</dt><dd>${specifications[specKey]}</dd>`;
        }
        cardContent += `</dl></div>`;
    }
    
    const variants = prod.variants;
    const boje = prod.boje;

    if (variants && Array.isArray(variants) && variants.length > 0) {
        const colorsId = `boje-${cardId}`;
        cardContent += `<h4 onclick="document.getElementById('${colorsId}').classList.toggle('expanded'); this.classList.toggle('expanded');">Boje</h4>
                        <div id="${colorsId}" class="collapsible-content">
                            <ul class="color-swatch-list">`;
        variants.forEach(variant => {
            cardContent += `<li>`;
            if (variant.swatch_url) {
                const isImageUrl = variant.swatch_url.startsWith('http');
                const backgroundStyle = isImageUrl
                    ? `background-image: url('${variant.swatch_url}');`
                    : `background: ${variant.swatch_url};`;
                
                const clickHandler = isImageUrl
                    ? `onclick="openFullscreenImage(['${variant.swatch_url}'], 0)"`
                    : '';
                
                cardContent += `<div class="color-swatch" style="${backgroundStyle}" title="${variant.name}" ${clickHandler}></div>`;
            }
            cardContent += `<span>${variant.name}</span></li>`;
        });
        cardContent += `</ul></div>`;
    } else if (boje && Array.isArray(boje) && boje.length > 0) {
        // Fallback to old format
        const colorsId = `boje-${cardId}`;
        cardContent += `<h4 onclick="document.getElementById('${colorsId}').classList.toggle('expanded'); this.classList.toggle('expanded');">Boje</h4>
                        <div id="${colorsId}" class="collapsible-content">
                            <ul class="color-swatch-list">`;
        boje.forEach(colorName => {
            cardContent += `<li><span>${colorName}</span></li>`;
        });
        cardContent += `</ul></div>`;
    }

    let hasOtherData = false;
    let otherDataContent = '<dl class="specs-list">';
    for (const key in prod) {
        if (!processedKeys.has(key) && Object.hasOwnProperty.call(prod, key)) {
            hasOtherData = true;
            otherDataContent += `<dt>${key}</dt><dd>`;
            const value = prod[key];
            if (typeof value === 'object' && value !== null) {
                otherDataContent += `<pre>${JSON.stringify(value, null, 2)}</pre>`;
            } else {
                otherDataContent += `${value === null || value === undefined ? 'N/A' : value}`;
            }
            otherDataContent += `</dd>`;
        }
    }
    otherDataContent += '</dl>';

    if (hasOtherData) {
        cardContent += `<h4 onclick="this.nextElementSibling.classList.toggle('expanded'); this.classList.toggle('expanded');">Ostali podaci</h4>
                        <div class="collapsible-content">` + otherDataContent + `</div>`;
    }

    // Move link to the bottom of the card
    if (prod.link) {
        const baseUrl = prod.link.startsWith('/') ? 'https://sonusart.ba' : '';
        cardContent += `<a href="${baseUrl}${prod.link}" target="_blank" rel="noopener noreferrer" class="link-button">Pogledaj ${prod.brend}</a>`;
    }

    card.innerHTML = cardContent;
    list.appendChild(card);
    
    // Add gallery listeners
    const gallery = card.querySelector(`#gallery-${cardId}`);
    if (gallery) {
      const mainImage = gallery.querySelector('.main-image');
      const thumbnails = gallery.querySelectorAll('.thumbnail');
      const prevBtn = gallery.querySelector('.prev');
      const nextBtn = gallery.querySelector('.next');
      let currentIndex = 0;

      function updateGallery(newIndex) {
        mainImage.src = imageUrls[newIndex];
        thumbnails.forEach((thumb, i) => {
          thumb.classList.toggle('active', i === newIndex);
        });
        currentIndex = newIndex;
      }
      
      if (imageUrls.length > 1) {
          prevBtn.addEventListener('click', () => {
              const newIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
              updateGallery(newIndex);
          });
          
          nextBtn.addEventListener('click', () => {
              const newIndex = (currentIndex + 1) % imageUrls.length;
              updateGallery(newIndex);
          });
          
          thumbnails.forEach(thumb => {
              thumb.addEventListener('click', (e) => {
                  const index = parseInt(e.target.dataset.index, 10);
                  updateGallery(index);
              });
          });
      }
      
      // Add a listener for fullscreen view
      mainImage.addEventListener('click', () => {
          openFullscreenImage(imageUrls, currentIndex);
      });
    }
  });
}
/**
 * Updates all displayed prices based on the selected currency.
 */
function updatePrices() {
    const priceElements = document.querySelectorAll('.product-price');
    priceElements.forEach(span => {
        const eurPrice = parseFloat(span.dataset.eurPrice);
        if (!isNaN(eurPrice)) {
            if (currentCurrency === 'EUR') {
                span.textContent = eurPrice.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
            } else { // KM
                const kmPrice = eurPrice * KM_CONVERSION_RATE;
                span.textContent = kmPrice.toLocaleString('de-DE', { style: 'currency', currency: 'BAM' });
            }
        }
    });
}
/**
 * Opens a fullscreen image modal.
 * @param {Array<string>} imageUrls List of image URLs.
 * @param {number} initialIndex Index of the image to display first.
 */
function openFullscreenImage(imageUrls, initialIndex) {
    const modal = document.getElementById('fullscreen-modal');
    const modalImage = document.getElementById('modal-image');
    const prevBtn = document.getElementById('modal-prev-btn');
    const nextBtn = document.getElementById('modal-next-btn');
    
    modalImageUrls = imageUrls;
    modalImageIndex = initialIndex;

    modalImage.src = modalImageUrls[modalImageIndex];
    modal.style.display = 'flex';
    
    if (modalImageUrls.length > 1) {
      prevBtn.style.display = 'block';
      nextBtn.style.display = 'block';
    } else {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
    }
}
/**
 * Displays the previous image in the fullscreen modal.
 */
function showPrevImage() {
    modalImageIndex = (modalImageIndex - 1 + modalImageUrls.length) % modalImageUrls.length;
    document.getElementById('modal-image').src = modalImageUrls[modalImageIndex];
}
/**
 * Displays the next image in the fullscreen modal.
 */
function showNextImage() {
    modalImageIndex = (modalImageIndex + 1) % modalImageUrls.length;
    document.getElementById('modal-image').src = modalImageUrls[modalImageIndex];
}
/**
 * Closes the fullscreen image modal.
 */
function closeFullscreenImage() {
    const modal = document.getElementById('fullscreen-modal');
    modal.style.display = 'none';
    const modalImage = document.getElementById('modal-image');
    modalImage.src = '';
    modalImageUrls = [];
    modalImageIndex = 0;
}

/**
 * Učitava podatke s interneta i sprema ih u Firestore.
 */
async function loadDataIntoFirestore() {
    showMessage("Učitavanje podataka u Firestore. Molimo pričekajte...");

    try {
        const [argonResponse, marantzResponse] = await Promise.all([
            fetch(RAW_ARGON),
            fetch(RAW_MARANTZ)
        ]);

        const argonData = await argonResponse.json();
        const marantzData = await marantzResponse.json();

        // Očistiti postojeću kolekciju prije dodavanja novih podataka
        const existingDocs = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/products`));
        existingDocs.forEach(async d => await deleteDoc(d.ref));

        const processedMarantz = marantzData.map(p => {
            const images = (p.images && Array.isArray(p.images)) ? p.images : [];
            if (images.length === 0 && p.image && p.image.trim() !== '') {
                images.push(p.image);
            }
            const processedImages = images.map(url => {
                if (url && url.startsWith('https://www.marantz.comhttps://www.marantz.com')) {
                    return url.replace('https://www.marantz.comhttps://www.marantz.com', 'https://www.marantz.com');
                }
                return url;
            }).filter(Boolean);

            const priceInUSD = normalizePrice(p.price);
            const priceInEUR = priceInUSD > 0 ? priceInUSD * USD_TO_EUR_RATE : 0;
            return {
                ...p,
                brend: "Marantz",
                naziv: p.name,
                eur_price: priceInEUR,
                cijena: p.price,
                opis: p.tagline,
                slika_url: processedImages.length > 0 ? processedImages[0] : null,
                images_urls: processedImages
            };
        });

        const processedArgon = Object.values(argonData.categories).flat().map(p => {
            let images = [];
            if (p.images && Array.isArray(p.images) && p.images.length > 0) {
                images = p.images;
            } else if (p.slika_url && p.slika_url.trim() !== '') {
                images = [p.slika_url];
            }
            const priceInEUR = normalizePrice(p.cijena || p.price);
            return {
                ...p,
                brend: "Argon",
                eur_price: priceInEUR,
                images_urls: images
            };
        });

        const allItems = [...processedArgon, ...processedMarantz];
        const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);

        for (const item of allItems) {
            await setDoc(doc(productsCollectionRef, item.id || crypto.randomUUID()), item);
        }

        showMessage("Podaci su uspješno učitani u Firestore!");
    } catch (e) {
        console.error("Greška pri učitavanju podataka u Firestore: ", e);
        showMessage("Greška: Nije moguće učitati podatke u Firestore. Provjerite konzolu za detalje.");
    }
}

// Inicijalizacija Firebase-a i slušanje promjena
async function initializeFirebase() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in anonymously if no user token is provided
        if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                console.log("Korisnik prijavljen s ID-om:", userId);
                startDataListener();
            } else {
                console.log("Korisnik nije prijavljen.");
                allItemsFlat = [];
                renderList([]);
            }
        });
    } catch (e) {
        console.error("Greška pri inicijalizaciji Firebase-a:", e);
        showMessage("Greška: Nije moguće inicijalizirati Firebase. Provjerite konzolu za detalje.");
    }
}

function startDataListener() {
    const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
    onSnapshot(productsCollectionRef, (querySnapshot) => {
        const products = [];
        querySnapshot.forEach((doc) => {
            products.push(doc.data());
        });
        
        allProducts = {};
        products.forEach(p => {
            const brand = p.brend;
            // Provjera da li `categories` postoji i da li je niz
            const category = (p.categories && Array.isArray(p.categories) && p.categories.length > 0) ? p.categories[0] : 'Nekategorisano';

            if (!allProducts[brand]) {
                allProducts[brand] = { categories: {} };
            }
            if (!allProducts[brand].categories[category]) {
                allProducts[brand].categories[category] = [];
            }
            allProducts[brand].categories[category].push(p);
        });
        
        allItemsFlat = products;
        
        renderCategoriesForBrand(currentBrand);
        highlightActiveCategory();
        applyFilters();
    });
}


document.getElementById("apply-btn").addEventListener("click", applyFilters);
document.getElementById("sort-select").addEventListener("change", applyFilters);
document.getElementById("feature-filter").addEventListener("change", applyFilters);
document.getElementById("only-priced").addEventListener("change", applyFilters);
document.getElementById("load-data-btn").addEventListener("click", loadDataIntoFirestore);

document.getElementById("brand-filter").addEventListener("change", (e) => {
    currentBrand = e.target.value;
    currentCategory = "ALL";
    renderCategoriesForBrand(currentBrand);
    highlightActiveCategory();
    applyFilters();
});

["search", "min-price", "max-price"].forEach(id => {
  document.getElementById(id).addEventListener("keydown", e => { if (e.key === "Enter") applyFilters(); });
});

document.getElementById('currency-eur').addEventListener('click', () => {
    currentCurrency = 'EUR';
    document.getElementById('currency-eur').classList.add('active');
    document.getElementById('currency-km').classList.remove('active');
    updatePrices();
});

document.getElementById('currency-km').addEventListener('click', () => {
    currentCurrency = 'KM';
    document.getElementById('currency-km').classList.add('active');
    document.getElementById('currency-eur').classList.remove('active');
    updatePrices();
});

// Listeners for the fullscreen modal
document.getElementById('modal-close-btn').addEventListener('click', closeFullscreenImage);
document.getElementById('fullscreen-modal').addEventListener('click', (e) => {
    if (e.target.id === 'fullscreen-modal') {
        closeFullscreenImage();
    }
});
document.getElementById('modal-prev-btn').addEventListener('click', showPrevImage);
document.getElementById('modal-next-btn').addEventListener('click', showNextImage);

window.addEventListener('keydown', (e) => {
    if (document.getElementById('fullscreen-modal').style.display === 'flex') {
        if (e.key === 'ArrowLeft') {
            showPrevImage();
        } else if (e.key === 'ArrowRight') {
            showNextImage();
        } else if (e.key === 'Escape') {
            closeFullscreenImage();
        }
    }
});

// Run initialization
document.getElementById("version-badge").textContent = `v${APP_VERSION}`;
document.title = `Katalog v${APP_VERSION}`;
initializeFirebase();

</script>

</body>
</html>
