<!DOCTYPE html>
<!--
CHANGELOG
v0.45.26 (2025-08-29) - Kritična ispravka: Dodata je puna navigacija za galeriju slika u punoj veličini. Sada se mogu koristiti dugmad 'prethodna' i 'sljedeća' za listanje kroz slike, a dodata je i podrška za navigaciju strelicama na tastaturi. Takođe je dodan i brojač slika.
v0.45.25 (2025-08-29) - Kritična ispravka: Sve slike sada se prikazuju u punoj veličini u galeriji i modalima. Dodata je funkcija `showFullImage` koja otvara sliku u novom skočnom prozoru.
v0.45.24 (2025-08-29) - Kritična ispravka: Dodata funkcionalnost za prikaz slike u punoj veličini. Klikom na sliku proizvoda na kartici ili u modalu sa detaljima otvara se novi skočni prozor koji prikazuje sliku u punoj rezoluciji radi detaljnijeg pregleda.
v0.45.23 (2025-08-28) - Kritična ispravka: Redovi u tabeli za poređenje koji sadrže specifikacije prisutne kod dva ili više proizvoda sada su istaknuti plavom pozadinom (`bg-blue-50`) radi lakše identifikacije zajedničkih parametara.
v0.45.22 (2025-08-28) - Kritična ispravka: Dugme za poređenje je sada plutajuće i uvek vidljivo u donjem desnom uglu stranice, nezavisno od skrolovanja. Koristi `position: fixed` za pozicioniranje i dodate su senka i tranzicije radi bolje vizuelne istaknutosti.
v0.45.21 (2025-02-28) - Kritična ispravka: Dugme za zatvaranje (X) u skočnim prozorima (modalima) je sada plutajuće. Pozicionirano je fiksno u odnosu na prozor, izvan okvira sadržaja modala, radi lakšeg pristupa.
v0.45.20 (2025-02-28) - Kritična ispravka: Potpuno redizajnirana logika za poređenje da bi se osigurao paralelan prikaz podataka. Implementirana nova i robusnija funkcija `formatDataToHtml` koja ispravno obrađuje ugniježdene objekte i liste, prikazujući ih u čitljivom HTML formatu unutar tabele za poređenje.
v0.45.19 (2025-02-28) - Kritična ispravka: Potpuno redizajnirana logika za poređenje. Implementirana prava tabelarna struktura gde prva kolona služi za nazive specifikacija, a naredne kolone za vrednosti svakog proizvoda, osiguravajući pravilan paralelni prikaz.
v0.45.18 (2025-02-28) - Kritična ispravka: Redizajnirana je logika za poređenje da bi se osigurao paralelan prikaz podataka. Sada se sve specifikacije, uključujući i one koje nisu zajedničke, prikazuju u istoj tabeli sa posebnom kolonom za naziv specifikacije.
v0.45.17 (2025-02-28) - Kritična ispravka: Popravljen prikaz JSON objekata u tabeli za poređenje. Sada se svi podaci, uključujući složene objekte i liste, pravilno formatiraju i prikazuju, umesto sirovog JSON teksta.
v0.45.16 (2025-02-28) - Revizija logike za poređenje. Sada se prvo prikazuju zajedničke specifikacije koje su prisutne na svim proizvodima, a zatim individualne specifikacije.
v0.45.15 (2025-02-28) - Uklonjeni nepotrebni podaci (URL-ovi logotipa, proizvoda i slika) iz sekcije sa detaljima u prozoru za poređenje.
v0.45.14 (2025-02-28) - Uklonjene slike proizvoda iz prozora za poređenje radi boljeg fokusa na specifikacije.
v0.45.13 (2025-02-28) - Dodana funkcionalnost za poređenje proizvoda. Korisnici sada mogu dodati proizvode u listu za poređenje i prikazati ih u posebnom modalu.
v0.45.12 (2025-02-28) - Popravljen raspored u skočnom prozoru (popup), naziv proizvoda je sada ispod logotipa.
v0.45.11 (2025-02-28) - Promijenjena lokacija i format changelog-a na vrh dokumenta.
v0.45.10 (2025-02-28) - Dodan changelog komentar za evidentiranje verzija koda.
v0.45.9 (2025-02-21) - Promijenjen Argon Audio logo iz placeholder slike u URL iz JSON-a, invertovana boja logotipa.
-->
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hi-Fi Uređaji</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for the modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px); /* Blur effect on background */
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 1.5rem;
            border-radius: 1rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        /* Floating close button position */
        .modal-close-btn {
            position: absolute;
            top: -2.5rem; /* Podesi poziciju van okvira */
            right: -2.5rem; /* Podesi poziciju van okvira */
            color: #d1d5db; /* Svetlo siva */
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.3s;
            z-index: 1001; /* Iznad modalnog sadržaja */
        }

        .modal-close-btn:hover {
            color: #f9fafb; /* Bela boja pri prelasku miša */
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* CSS class to invert logo color (white becomes black) */
        .invert-logo {
            filter: invert(1);
        }
        /* New styles for the compare button and modal */
        #compareButton {
            display: none; /* Initially hidden */
            position: fixed; /* Make it float */
            bottom: 2rem; /* Position from the bottom */
            right: 2rem; /* Position from the right */
            z-index: 50; /* Ensure it's above other content */
        }
        #compareModal .modal-content {
            max-width: 1200px;
        }
        .compare-table {
            width: 100%;
            border-collapse: collapse;
        }
        .compare-table th, .compare-table td {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: top;
        }
        .compare-table th {
            background-color: #f9fafb;
            font-weight: bold;
            color: #1f2937;
        }
        /* Highlight class for rows with common specs */
        .highlight-row {
            background-color: #f0f9ff; /* Blago plava pozadina */
        }

        /* New styles for the image modal */
        #imageModal .modal-content {
            padding: 0;
            background-color: transparent;
            box-shadow: none;
            max-width: 90vw;
            max-height: 90vh;
            display: flex; /* Flexbox for centering image and buttons */
            align-items: center;
            justify-content: center;
        }
        #imageModal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <!-- Header and search bar -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800">Hi-Fi Uređaji</h1>
        <!-- Logo container -->
        <div id="logoContainer" class="flex justify-center items-center mt-4 h-16"></div>
        <p class="text-lg text-gray-600 mt-2">Pregled audio i video uređaja iz raznih izvora</p>
        <div class="flex items-center justify-center mt-4 space-x-4">
            <input type="text" id="searchInput" placeholder="Pretraži po imenu ili proizvođaču..." class="p-3 w-full max-w-lg rounded-full border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
        </div>
    </header>

    <!-- Product display container -->
    <main id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <!-- Products will be dynamically added here -->
    </main>
    
    <!-- Floating compare button -->
    <button id="compareButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-colors duration-300">
        Poredi (<span id="compareCount">0</span>)
    </button>
    
    <!-- Modal for product details -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <button id="closeModal" class="modal-close-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="modalContentInner">
                <!-- Product details will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- New Modal for comparison -->
    <div id="compareModal" class="modal">
        <div class="modal-content">
            <button id="closeCompareModal" class="modal-close-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="compareContentInner" class="grid gap-8">
                <!-- Comparison data will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- New Modal for full-size image viewing with navigation -->
    <div id="imageModal" class="modal">
        <div class="relative w-full h-full flex items-center justify-center">
            <button id="closeImageModal" class="absolute top-4 right-4 text-white text-3xl font-bold p-2 leading-none rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 focus:outline-none z-20">
                &times;
            </button>
            <button id="prevImageBtn" class="nav-button absolute left-4 md:left-8 top-1/2 transform -translate-y-1/2 text-white text-5xl p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 focus:outline-none z-10">
                &lsaquo;
            </button>
            <img id="fullSizeImage" src="" alt="Full size image" class="max-w-full max-h-[90vh] rounded-lg shadow-lg">
            <button id="nextImageBtn" class="nav-button absolute right-4 md:right-8 top-1/2 transform -translate-y-1/2 text-white text-5xl p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 focus:outline-none z-10">
                &rsaquo;
            </button>
            <div id="imageCounter" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-50 text-white text-sm px-3 py-1 rounded-full z-10"></div>
        </div>
    </div>

    <script>
        // Main function to start the application
        document.addEventListener('DOMContentLoaded', async () => {
            const searchInput = document.getElementById('searchInput');
            const productsContainer = document.getElementById('productsContainer');
            const logoContainer = document.getElementById('logoContainer');
            const productModal = document.getElementById('productModal');
            const closeModalBtn = document.getElementById('closeModal');
            const modalContentInner = document.getElementById('modalContentInner');
            const compareButton = document.getElementById('compareButton');
            const compareCountSpan = document.getElementById('compareCount');
            const compareModal = document.getElementById('compareModal');
            const closeCompareModalBtn = document.getElementById('closeCompareModal');
            const compareContentInner = document.getElementById('compareContentInner');
            const imageModal = document.getElementById('imageModal');
            const closeImageModalBtn = document.getElementById('closeImageModal');
            const fullSizeImage = document.getElementById('fullSizeImage');
            const prevImageBtn = document.getElementById('prevImageBtn');
            const nextImageBtn = document.getElementById('nextImageBtn');
            const imageCounter = document.getElementById('imageCounter');

            let allProducts = [];
            let productsToCompare = [];
            let currentImages = []; // Array to hold images of the currently viewed product
            let currentImageIndex = 0; // Index of the current image

            // URLs for JSON files
            const marantzUrl = 'https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/main/json/marantz_all_products.json';
            const argonUrl = 'https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/main/json/argon_audio_products_all_categories.json';

            /**
             * Funkcija za preuzimanje podataka sa URL-a.
             * Koristi eksponencijalni povratak za ponovne pokušaje u slučaju neuspeha.
             */
            async function fetchData(url, retries = 3, delay = 1000) {
                try {
                    console.log(`Pokušavam da preuzmem podatke sa: ${url}`);
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.error(`HTTP greška! Status: ${response.status} za URL: ${url}`);
                        throw new Error(`HTTP greška! Status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log(`Uspešno preuzeti podaci sa ${url}.`);
                    return data;
                } catch (error) {
                    console.error(`Greška pri dobijanju podataka sa ${url}. Pokušaj broj: ${4 - retries}`);
                    if (retries > 0) {
                        console.log(`Pokušavam ponovo za ${delay / 1000} sekundi...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchData(url, retries - 1, delay * 2);
                    }
                    console.error(`Preuzimanje sa ${url} nije uspelo nakon više pokušaja.`);
                    return null; // Vrati null ako preuzimanje ne uspe
                }
            }

            /**
             * Funkcija za učitavanje i obradu JSON fajlova.
             * Normalizuje podatke iz oba fajla u jedinstven format.
             */
            async function loadAndProcessData() {
                try {
                    console.log("Počinjem učitavanje i obradu podataka.");
                    
                    const [marantzData, argonData] = await Promise.all([
                        fetchData(marantzUrl),
                        fetchData(argonUrl)
                    ]);
                    
                    // Normalizuj Marantz podatke - JSON je direktan niz objekata
                    const normalizedMarantz = (marantzData && Array.isArray(marantzData)) ? marantzData.map(product => ({
                        ime: product.ime_proizvoda || 'Nema imena',
                        proizvodjac: 'Marantz',
                        kategorija: product.kategorije && Array.isArray(product.kategorije) ? product.kategorije.join(', ') : 'Nema kategorije',
                        cena: product.cena ? product.cena : 'Cena nije dostupna',
                        slike: product.url_slika && Array.isArray(product.url_slika) ? product.url_slika : [],
                        url: product.url_proizvoda || '',
                        opis: product.opis || 'Nema opisa.',
                        logo: product.brend_logo_url || '',
                        originalniPodaci: product, // Sačuvaj originalne podatke
                        id: product.url_proizvoda // Koristi jedinstveni ID
                    })) : [];
                    console.log("Broj normalizovanih Marantz proizvoda:", normalizedMarantz.length);
                    
                    // Normalizuj Argon Audio podatke - JSON je takođe direktan niz objekata
                    const normalizedArgon = (argonData && Array.isArray(argonData)) ? argonData.map(product => ({
                        ime: product.ime_proizvoda || 'Nema imena',
                        proizvodjac: 'Argon Audio',
                        kategorija: product.kategorije && Array.isArray(product.kategorije) ? product.kategorije.join(', ') : 'Nema kategorije',
                        cena: product.cena ? product.cena : 'Cena nije dostupna',
                        slike: product.url_slika && Array.isArray(product.url_slika) ? product.url_slika : [],
                        url: product.url_proizvoda || '',
                        opis: product.opis || 'Nema opisa.',
                        logo: product.brend_logo_url || '',
                        originalniPodaci: product, // Sačuvaj originalne podatke
                        id: product.url_proizvoda // Koristi jedinstveni ID
                    })) : [];
                    console.log("Broj normalizovanih Argon Audio proizvoda:", normalizedArgon.length);

                    // Kombinuj sve proizvode u jednu listu
                    allProducts = [...normalizedMarantz, ...normalizedArgon];
                    console.log("Svi proizvodi (spojeni):", allProducts);
                    console.log("Ukupan broj proizvoda:", allProducts.length);

                    displayProducts(allProducts);

                } catch (error) {
                    productsContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">Greška pri učitavanju podataka. Molimo proverite URL-ove ili pokušajte ponovo kasnije.</p>';
                    console.error("Fatalna greška pri obradi podataka:", error);
                }
            }
            
            /**
             * Funkcija za dodavanje/uklanjanje proizvoda za poređenje.
             */
            function toggleCompareProduct(product) {
                const index = productsToCompare.findIndex(p => p.id === product.id);
                if (index > -1) {
                    productsToCompare.splice(index, 1); // Ukloni iz liste
                    console.log(`Proizvod uklonjen iz liste za poređenje: ${product.ime}`);
                } else {
                    productsToCompare.push(product); // Dodaj u listu
                    console.log(`Proizvod dodan u listu za poređenje: ${product.ime}`);
                }
                updateCompareButton();
            }

            /**
             * Funkcija za ažuriranje vidljivosti i broja na dugmetu za poređenje.
             */
            function updateCompareButton() {
                compareCountSpan.textContent = productsToCompare.length;
                if (productsToCompare.length > 0) {
                    compareButton.style.display = 'block';
                } else {
                    compareButton.style.display = 'none';
                }
            }

            /**
             * Funkcija za prikaz proizvoda na stranici.
             * Dinamički dodaje CSS klasu za inverziju boje logotipa Argon Audio.
             */
            function displayProducts(products) {
                console.log("Prikazujem proizvode. Broj proizvoda za prikaz:", products.length);
                productsContainer.innerHTML = ''; // Očisti kontejner
                logoContainer.innerHTML = ''; // Očisti glavni kontejner logotipa
                
                if (products.length === 0) {
                    productsContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">Nema pronađenih uređaja.</p>';
                    console.log("Nema pronađenih proizvoda za prikaz.");
                    return;
                }

                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300 cursor-pointer';
                    
                    // Obradi galeriju slika
                    const images = product.slike || [];
                    const firstImage = images.length > 0 ? images[0] : 'https://placehold.co/400x300/a3e635/000000?text=No+Image';

                    // Ograniči opis na prvih 100 karaktera
                    const shortDescription = product.opis ? (product.opis.length > 100 ? product.opis.substring(0, 100) + '...' : product.opis) : 'Nema opisa.';
                    
                    // Odredi CSS klasu za logo
                    const logoClass = product.proizvodjac === 'Argon Audio' ? 'invert-logo' : '';

                    // Proveri da li je proizvod već u listi za poređenje
                    const isCompared = productsToCompare.some(p => p.id === product.id);
                    const compareButtonText = isCompared ? 'Ukloni za poređenje' : 'Dodaj za poređenje';
                    const compareButtonClass = isCompared ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600';

                    productCard.innerHTML = `
                        <div class="p-4 flex justify-center items-center">
                            ${product.logo ? `<img src="${product.logo}" alt="${product.proizvodjac} Logo" class="h-12 w-auto object-contain ${logoClass}" onerror="this.onerror=null;this.src='https://placehold.co/100x48/f3f4f6/000000?text=${product.proizvodjac}';">` : ''}
                        </div>
                        <div class="relative w-full h-48">
                            <img src="${firstImage}" alt="${product.ime}" class="w-full h-full object-contain object-center product-image cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x300/a3e635/000000?text=Image+Not+Found';">
                            ${images.length > 1 ? `
                                <!-- Kontrole galerije -->
                                <button class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 transition-colors prev-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                    </svg>
                                </button>
                                <button class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 transition-colors next-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                                <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-50 text-white text-xs px-2 py-1 rounded-full image-counter">
                                    1 / ${images.length}
                                </div>
                            ` : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-xl mb-1 truncate">${product.ime}</h3>
                            <p class="text-sm text-gray-500 mb-2 truncate">${product.proizvodjac} - ${product.kategorija}</p>
                            <p class="text-lg font-semibold text-green-600 mb-2">${product.cena}</p>
                            <p class="text-gray-700 text-sm mb-4">${shortDescription}</p>
                            <button class="${compareButtonClass} text-white font-bold py-2 px-4 rounded-lg text-sm w-full transition-colors compare-add-btn" data-product-id="${product.id}">${compareButtonText}</button>
                        </div>
                    `;
                    
                    // Dodaj "click" event listener da bi se prikazali svi detalji
                    productCard.querySelector('div').addEventListener('click', () => showProductDetails(product));
                    // Dodaj "click" event listener za sliku na kartici
                    const imageCardEl = productCard.querySelector('.product-image');
                    imageCardEl.addEventListener('click', (e) => {
                        e.stopPropagation(); // Spreči otvaranje modala za detalje
                        showFullImage(product.slike, 0); // Pozovi novu funkciju s galerijom
                    });

                    // Dodaj "event listener" za dugme za poređenje
                    const compareAddBtn = productCard.querySelector('.compare-add-btn');
                    compareAddBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Spreči otvaranje modala
                        toggleCompareProduct(product);
                        // Ponovo renderuj da bi se ažurirao tekst dugmeta
                        displayProducts(allProducts);
                    });

                    // Dodaj "event listener" za navigaciju u galeriji na kartici
                    if (images.length > 1) {
                        const prevBtn = productCard.querySelector('.prev-btn');
                        const nextBtn = productCard.querySelector('.next-btn');
                        const imageEl = productCard.querySelector('.product-image');
                        const counterEl = productCard.querySelector('.image-counter');
                        let currentImageIndex = 0;

                        const updateGallery = () => {
                            imageEl.src = images[currentImageIndex];
                            counterEl.textContent = `${currentImageIndex + 1} / ${images.length}`;
                        };

                        prevBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation(); // Spreči otvaranje modala
                            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                            updateGallery();
                        });

                        nextBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation(); // Spreči otvaranje modala
                            currentImageIndex = (currentImageIndex + 1) % images.length;
                            updateGallery();
                        });
                    }
                    
                    productsContainer.appendChild(productCard);
                });
            }
            
            // Definiši ključeve koje treba isključiti iz sekcije "Ostali podaci"
            const excludedKeys = ['ime_proizvoda', 'ime', 'proizvodjac', 'kategorije', 'kategorija', 'cena', 'slike', 'url_slika', 'url', 'url_proizvoda', 'opis', 'brend_logo_url', 'logo', 'originalniPodaci', 'id', 'id', 'tagline', 'funkcije', 'ocjene', 'glavne_funkcije'];

            /**
             * Pomoćna funkcija za formatiranje ključa za prikaz.
             */
            function formatKey(key) {
                // Proveri da li je ključ string i obradi ga u skladu sa tim
                if (typeof key !== 'string') {
                    return key;
                }
                const words = key.split('_').join(' ').split(/(?=[A-Z])/).join(' ');
                return words.charAt(0).toUpperCase() + words.slice(1);
            }

            /**
             * Nova, rekurzivna pomoćna funkcija za formatiranje i prikaz podataka, uključujući ugniježdene objekte i nizove.
             * Ova funkcija je optimizovana za čitljivost unutar ćelije tabele.
             */
            function formatDataToHtml(data) {
                // Ako je boolean, prikaži "Da" ili "Ne"
                if (typeof data === 'boolean') {
                    return data ? 'Da' : 'Ne';
                }
                // Ako je objekat (nije null)
                if (typeof data === 'object' && data !== null) {
                    if (Array.isArray(data)) {
                        // Ako je prazan niz, vrati "—"
                        if (data.length === 0) return '—';
                        // Ako je niz jednostavnih vrednosti (string, broj)
                        if (typeof data[0] === 'string' || typeof data[0] === 'number') {
                            return data.join(', ');
                        } else {
                            // Niz objekata (poput "funkcije" u JSON-u)
                            const listItems = data.map(item => {
                                if (typeof item === 'object' && item !== null) {
                                    const sublistItems = Object.entries(item)
                                        .map(([key, value]) => `<li class="ml-4"><span class="font-semibold">${formatKey(key)}:</span> ${formatDataToHtml(value)}</li>`)
                                        .join('');
                                    return `<ul>${sublistItems}</ul>`;
                                }
                                return `<li>${formatDataToHtml(item)}</li>`;
                            });
                            return `<div>${listItems.join('')}</div>`;
                        }
                    } else {
                        // Ugniježdeni objekat (poput "specifikacije" ili "dodatne_informacije")
                        const listItems = Object.entries(data)
                            .map(([key, value]) => `<div class="mb-1"><span class="font-semibold">${formatKey(key)}:</span> ${formatDataToHtml(value)}</div>`)
                            .join('');
                        return `<div class="bg-gray-50 rounded-md p-2 mt-2">${listItems}</div>`;
                    }
                }
                // Ako je jednostavna vrednost, samo je vrati
                return data;
            }

            /**
             * Funkcija za prikaz svih detalja jednog proizvoda u modalu.
             * Dinamički dodaje CSS klasu za inverziju boje logotipa Argon Audio.
             */
            function showProductDetails(product) {
                console.log("Prikazujem detalje za proizvod:", product.ime);
                
                const images = product.slike || [];
                const fullDescription = product.opis || 'Nema opisa.';
                const originalData = product.originalniPodaci || {};

                // Filtriraj isključene ključeve pre formatiranja podataka
                const filteredOriginalData = {};
                for (const key in originalData) {
                    if (originalData.hasOwnProperty(key) && !excludedKeys.includes(key)) {
                        filteredOriginalData[key] = originalData[key];
                    }
                }

                const otherDataHtml = formatDataToHtml(filteredOriginalData);
                
                // Odredi CSS klasu za logo
                const logoClass = product.proizvodjac === 'Argon Audio' ? 'invert-logo' : '';

                // Sastavi unutrašnji HTML modala
                modalContentInner.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Leva strana: Galerija slika -->
                        <div class="flex flex-col items-center">
                            <div class="relative w-full h-80 rounded-lg overflow-hidden">
                                <img src="${images[0] || 'https://placehold.co/800x600/a3e635/000000?text=No+Image'}" alt="${product.ime}" class="w-full h-full object-contain product-modal-image cursor-pointer transition-opacity duration-300" onerror="this.onerror=null;this.src='https://placehold.co/800x600/a3e635/000000?text=Image+Not+Found';">
                                ${images.length > 1 ? `
                                    <button class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 transition-colors prev-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    <button class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 transition-colors next-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-50 text-white text-sm px-3 py-1 rounded-full image-modal-counter">
                                        1 / ${images.length}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Desna strana: Tekstualni detalji -->
                        <div>
                            <div class="flex flex-col items-start mb-2">
                                ${product.logo ? `<img src="${product.logo}" alt="${product.proizvodjac} Logo" class="h-8 mb-2 rounded-md ${logoClass}">` : ''}
                                <h2 class="text-3xl font-bold text-gray-800">${product.ime}</h2>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">${product.proizvodjac} - ${product.kategorija}</p>
                            <p class="text-2xl font-semibold text-green-600 mb-4">${product.cena}</p>
                            <p class="text-gray-700 leading-relaxed mb-6 whitespace-pre-wrap">${fullDescription}</p>
                            ${product.url ? `<a href="${product.url}" target="_blank" class="inline-block bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Poseti web sajt proizvoda</a>` : ''}
                        </div>
                    </div>
                    
                    ${Object.keys(filteredOriginalData).length > 0 ? `
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">Ostali podaci:</h3>
                            ${formatDataToHtml(filteredOriginalData)}
                        </div>
                    ` : ''}
                `;

                // Dodaj "event listener" za navigaciju u galeriji u modalu
                if (images.length > 1) {
                    const prevBtn = modalContentInner.querySelector('.prev-btn');
                    const nextBtn = modalContentInner.querySelector('.next-btn');
                    const imageEl = modalContentInner.querySelector('.product-modal-image');
                    const counterEl = modalContentInner.querySelector('.image-modal-counter');
                    let currentImageIndex = 0;

                    const updateGallery = () => {
                        imageEl.src = images[currentImageIndex];
                        counterEl.textContent = `${currentImageIndex + 1} / ${images.length}`;
                    };

                    prevBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation(); // Spreči zatvaranje modala
                        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                        updateGallery();
                    });

                    nextBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation(); // Spreči zatvaranje modala
                        currentImageIndex = (currentImageIndex + 1) % images.length;
                        updateGallery();
                    });
                    
                    // Add click event listener to the image in the modal itself
                    imageEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showFullImage(product.slike, currentImageIndex); // Pozovi novu funkciju s galerijom i trenutnim indeksom
                    });
                }

                // Prikaži modal
                productModal.style.display = 'flex';
                // Koristi timeout da primeniš klasu za tranziciju
                setTimeout(() => productModal.classList.add('show'), 10);
            }

            /**
             * Funkcija za prikaz modala za poređenje.
             */
            function showCompareModal() {
                if (productsToCompare.length === 0) {
                    return;
                }
                
                compareContentInner.innerHTML = '';
                
                // 1. Pripremi listu svih jedinstvenih ključeva iz svih proizvoda
                const allKeys = new Set();
                const keyCounts = new Map();

                productsToCompare.forEach(p => {
                    const originalData = p.originalniPodaci || {};
                    const relevantKeys = new Set();

                    // Dodaj ključeve sa glavnog nivoa
                    for (const key in originalData) {
                        if (originalData.hasOwnProperty(key) && !excludedKeys.includes(key) && key !== 'specifikacije' && key !== 'dodatne_informacije') {
                             relevantKeys.add(key);
                             allKeys.add(key);
                        }
                    }
                    // Dodaj ključeve iz specifikacija i dodatnih informacija
                    const specs = originalData.specifikacije || {};
                    for (const key in specs) {
                         if (specs.hasOwnProperty(key)) {
                            relevantKeys.add(`specifikacije.${key}`);
                            allKeys.add(`specifikacije.${key}`);
                        }
                    }
                    const additional = originalData.dodatne_informacije || {};
                    for (const key in additional) {
                         if (additional.hasOwnProperty(key)) {
                            relevantKeys.add(`dodatne_informacije.${key}`);
                            allKeys.add(`dodatne_informacije.${key}`);
                        }
                    }
                    
                    // Ažuriraj brojač prisutnosti za svaki ključ
                    relevantKeys.forEach(key => {
                        const currentCount = keyCounts.get(key) || 0;
                        keyCounts.set(key, currentCount + 1);
                    });
                });

                // Pretvori set u niz za sortiranje
                const sortedKeys = Array.from(allKeys).sort();

                // 2. Kreiranje zaglavlja tabele
                let tableHtml = `
                    <table class="compare-table rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="w-1/4">Specifikacije</th>
                                ${productsToCompare.map(p => `
                                    <th class="text-center">
                                        <div class="flex flex-col items-center">
                                            ${p.logo ? `<img src="${p.logo}" alt="${p.proizvodjac} Logo" class="h-10 w-auto mb-2 rounded-md ${p.proizvodjac === 'Argon Audio' ? 'invert-logo' : ''}">` : ''}
                                            <h3 class="font-bold text-lg">${p.ime}</h3>
                                            <p class="text-sm text-gray-500">${p.proizvodjac}</p>
                                            <p class="text-xl font-semibold text-green-600 mt-2">${p.cena}</p>
                                        </div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                // 3. Prikaz podataka za svaki ključ u novom redu
                sortedKeys.forEach(fullKey => {
                    // Dodaj klasu za isticanje ako se ključ pojavljuje više od jednom
                    const rowClass = keyCounts.get(fullKey) > 1 ? 'highlight-row' : '';

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td class="font-semibold text-gray-700">${formatKey(fullKey.split('.').pop())}</td>
                            ${productsToCompare.map(product => {
                                const originalData = product.originalniPodaci;
                                let value;
                                
                                // Pronađi vrednost na osnovu punog ključa (npr. 'specifikacije.snaga')
                                const keyParts = fullKey.split('.');
                                if (keyParts.length > 1) {
                                    const parentKey = keyParts[0];
                                    const childKey = keyParts[1];
                                    value = originalData[parentKey]?.[childKey];
                                } else {
                                    value = originalData[fullKey];
                                }
                                
                                const displayValue = value !== undefined ? formatDataToHtml(value) : '—';
                                return `<td class="text-gray-600">${displayValue}</td>`;
                            }).join('')}
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                    </table>
                `;

                compareContentInner.innerHTML = tableHtml;
                
                compareModal.style.display = 'flex';
                setTimeout(() => compareModal.classList.add('show'), 10);
            }

            /**
             * Funkcija za prikaz slike u punoj veličini.
             */
            function showFullImage(images, startIndex) {
                if (!images || images.length === 0) return;
                
                currentImages = images;
                currentImageIndex = startIndex;

                // Ažuriraj prikaz
                fullSizeImage.src = currentImages[currentImageIndex];
                imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
                
                // Pokaži ili sakrij gumbe za navigaciju ako ima samo jedna slika
                if (currentImages.length <= 1) {
                    prevImageBtn.style.display = 'none';
                    nextImageBtn.style.display = 'none';
                } else {
                    prevImageBtn.style.display = 'block';
                    nextImageBtn.style.display = 'block';
                }

                // Prikaži modal
                imageModal.style.display = 'flex';
                setTimeout(() => imageModal.classList.add('show'), 10);
            }

            /**
             * Funkcija za navigaciju unazad u galeriji.
             */
            function prevImage() {
                currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
                fullSizeImage.src = currentImages[currentImageIndex];
                imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            }

            /**
             * Funkcija za navigaciju naprijed u galeriji.
             */
            function nextImage() {
                currentImageIndex = (currentImageIndex + 1) % currentImages.length;
                fullSizeImage.src = currentImages[currentImageIndex];
                imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            }

            /**
             * Funkcija za filtriranje proizvoda na osnovu unosa za pretragu.
             */
            function filterProducts() {
                const searchTerm = searchInput.value.toLowerCase();
                console.log(`Pretražujem za: "${searchTerm}"`);

                const filteredProducts = allProducts.filter(product => {
                    const nameMatch = product.ime.toLowerCase().includes(searchTerm);
                    const manufacturerMatch = product.proizvodjac.toLowerCase().includes(searchTerm);
                    return nameMatch || manufacturerMatch;
                });
                console.log("Filtrirani proizvodi:", filteredProducts);
                displayProducts(filteredProducts);
            }

            // Funkcionalnost za zatvaranje modala
            closeModalBtn.addEventListener('click', () => {
                productModal.classList.remove('show');
                setTimeout(() => productModal.style.display = 'none', 300);
            });
            productModal.addEventListener('click', (e) => {
                // Zatvori modal samo ako se klikne na pozadinu, a ne na sadržaj
                if (e.target === productModal) {
                    productModal.classList.remove('show');
                    setTimeout(() => productModal.style.display = 'none', 300);
                }
            });

            // Funkcionalnost za zatvaranje modala za poređenje
            closeCompareModalBtn.addEventListener('click', () => {
                compareModal.classList.remove('show');
                setTimeout(() => compareModal.style.display = 'none', 300);
            });
            compareModal.addEventListener('click', (e) => {
                if (e.target === compareModal) {
                    compareModal.classList.remove('show');
                    setTimeout(() => compareModal.style.display = 'none', 300);
                }
            });

            // Funkcionalnost za zatvaranje modala za sliku
            closeImageModalBtn.addEventListener('click', () => {
                imageModal.classList.remove('show');
                setTimeout(() => imageModal.style.display = 'none', 300);
            });
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    imageModal.classList.remove('show');
                    setTimeout(() => imageModal.style.display = 'none', 300);
                }
            });

            // Event listeners za navigaciju u galeriji slika
            prevImageBtn.addEventListener('click', prevImage);
            nextImageBtn.addEventListener('click', nextImage);

            // Dodavanje podrške za tipke na tipkovnici
            document.addEventListener('keydown', (e) => {
                if (!imageModal.classList.contains('hidden')) {
                    if (e.key === 'ArrowLeft') {
                        prevImage();
                    } else if (e.key === 'ArrowRight') {
                        nextImage();
                    } else if (e.key === 'Escape') {
                        closeImageModalBtn.click();
                    }
                }
            });


            // Dodaj "event listener" za unos u pretragu
            searchInput.addEventListener('input', filterProducts);
            compareButton.addEventListener('click', showCompareModal);


            // Početno učitavanje podataka
            loadAndProcessData();
        });
    </script>

</body>
</html>
