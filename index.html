<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Audio Katalog – v1.3.7</title>
    <style>
        :root { --primary:#1a1a1a; --secondary:#2c3e50; --accent:#e74c3c; --border:#ddd; --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.1); }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
        body{background:#f5f7fa;color:var(--primary);line-height:1.6;}
        header{background:var(--primary);color:white;padding:1.5rem 0;text-align:center;box-shadow:var(--shadow);}
        header h1{font-size:2rem;margin-bottom:.5rem;}
        .subtitle{font-size:1rem;opacity:0.9;}
        #updateInfo{color:#27ae60;font-weight:600;}
        .controls{max-width:1200px;margin:2rem auto;padding:0 1rem;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;}
        .search-box,.filter-select{padding:.75rem 1rem;border:1px solid var(--border);border-radius:var(--radius);font-size:1rem;flex:1;min-width:200px;}
        .search-box:focus,.filter-select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(231,76,60,.2);}
        .stats{font-size:.9rem;color:#666;margin-left:auto;}
        .container{max-width:1200px;margin:0 auto;padding:0 1rem;}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;margin-top:1rem;}
        .card{background:white;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:.3s;cursor:pointer;position:relative;}
        .card:hover{transform:translateY(-8px);box-shadow:0 12px 24px rgba(0,0,0,.15);}
        .card-img{height:220px;background:#fff;position:relative;overflow:hidden;}
        .card-img img.product{width:100%;height:100%;object-fit:contain;transition:transform .3s;}
        .card:hover .card-img img.product{transform:scale(1.05);}
        .brand-logo-container{position:absolute;top:10px;left:10px;z-index:3;background:rgba(255,255,255,.95);
            padding:6px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.2);width:50px;height:50px;
            display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:.7rem;text-align:center;}
        .brand-logo-container img{width:40px;height:40px;object-fit:contain;}
        .brand-logo-container img.force-dark{filter:invert(1) hue-rotate(180deg) brightness(.9)!important;}
        .card-body{padding:1rem;display:flex;flex-direction:column;}
        .card-category{font-size:.85rem;color:var(--accent);font-weight:500;margin-bottom:.5rem;text-transform:capitalize;}
        .card-title{font-size:1.1rem;font-weight:600;color:var(--secondary);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
        .card-sku{font-size:.85rem;color:#777;margin-bottom:.5rem;}
        .card-price{font-size:1.3rem;font-weight:700;color:var(--accent);margin:.5rem 0;}
        .colors{display:flex;gap:6px;flex-wrap:wrap;margin-top:auto;padding-top:.75rem;}
        .color-swatch{width:24px;height:24px;border-radius:50%;border:2px solid white;box-shadow:0 0 0 1px #ccc;overflow:hidden;}
        .color-swatch img{width:100%;height:100%;object-fit:cover;}
        .color-swatch.hex{background:var(--swatch-color);}
        .loading,.no-results{text-align:center;padding:3rem 1rem;color:#777;font-size:1.1rem;}
        .footer{text-align:center;padding:2rem 1rem;color:#777;font-size:.9rem;margin-top:3rem;border-top:1px solid var(--border);}
    </style>
</head>
<body>
    <header>
        <h1>Audio Katalog</h1>
        <p class="subtitle">Live sa GitHub-a – v1.3.7 <span id="updateInfo"></span></p>
    </header>

    <div class="controls">
        <input type="text" class="search-box" placeholder="Pretraži po imenu..." id="searchInput" />
        <select class="filter-select" id="brandFilter"><option value="">Svi brendovi</option></select>
        <select class="filter-select" id="categoryFilter"><option value="">Sve kategorije</option></select>
        <div class="stats" id="stats">Učitavanje...</div>
    </div>

    <div class="container">
        <div id="loading" class="loading">Učitavanje najnovijih podataka sa GitHub-a...</div>
        <div id="grid" class="grid" style="display:none;"></div>
        <div id="noResults" class="no-results" style="display:none;">Nema rezultata.</div>
    </div>

    <footer class="footer">
        <p>web_app_v1.3.7.html – automatski prati najnoviji commit</p>
    </footer>

    <script>
        // AUTOMATSKO PREPOZNAVANJE NAJNOVIJEG COMMIT-A
        async function getLatestCommit() {
            try {
                const res = await fetch('https://api.github.com/repos/MikiMix-Git/SonusArtBA/commits/main');
                if (!res.ok) throw new Error('API greška');
                const data = await res.json();
                return data.sha;
            } catch (e) {
                console.warn('Ne mogu dohvatiti commit, koristim fallback', e);
                return '50d26ef9994e5858c77f5dc995aff403f99ea1af'; // posljednji poznati
            }
        }

        let GITHUB_RAW_BASE = '';
        const jsonFiles = [
            '/argon_audio_products_all_categories.json',
            '/bowers_wilkins_products.json',
            '/denon_products.json',
            '/dynaudio_products.json',
            '/marantz_all_products.json',
            '/qacoustics_products.json'
        ];

        let allProducts = [], brands = new Set(), categories = new Set();
        const grid = document.getElementById('grid');
        const loading = document.getElementById('loading');
        const noResults = document.getElementById('noResults');
        const searchInput = document.getElementById('searchInput');
        const brandFilter = document.getElementById('brandFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const stats = document.getElementById('stats');
        const updateInfo = document.getElementById('updateInfo');
        const fallback = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22><rect width=%22400%22 height=%22300%22 fill=%22%23f0f0f0%22/><text x=%22200%22 y=%22150%22 font-size=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22>No Image</text></svg>';

        // GLAVNI POČETAK – sve čeka najnoviji commit
        (async () => {
            const latestCommit = await getLatestCommit();
            GITHUB_RAW_BASE = `https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/${latestCommit}/json`;

            // Prikaz korisniku da su podaci svježi
            const date = new Date().toLocaleDateString('sr-RS');
            updateInfo.textContent = `– Podaci ažurirani: ${date} (commit ${latestCommit.slice(0,7)})`;

            // Sada učitavamo sve fajlove sa najnovijim commit-om
            const promises = jsonFiles.map(async file => {
                const url = GITHUB_RAW_BASE + file;
                const data = await fetch(url).then(r => r.ok ? r.json() : []).catch(() => []);
                data.forEach(p => p._sourceUrl = url);
                return data;
            });

            const results = await Promise.all(promises);
            allProducts = results.flat();

            allProducts.forEach(p => {
                const brand = getBrandDisplay(p, p._sourceUrl).name;
                brands.add(brand);
                if (p.kategorije) categories.add(p.kategorije);
            });

            populateFilters();
            renderProducts();
            loading.style.display = 'none';
            grid.style.display = 'grid';
        })();

        function getBrandDisplay(p, sourceUrl = '') {
            const logo = p.brend_logo_url || '';
            const map = { 'qacoustics':'Q Acoustics', 'dynaudio':'Dynaudio', 'marantz':'Marantz', 'denon':'Denon', 'bowers':'Bowers & Wilkins', 'argon':'Argon Audio' };
            for (const key in map) if (logo.includes(key)) return { name:map[key], url:logo };
            const fb = /([^\/]+)\_products/.exec(sourceUrl);
            const name = fb ? map[fb[1]] || fb[1] : 'Audio';
            return { name, url:logo || null };
        }

        function populateFilters() {
            [...brands].sort().forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;brandFilter.appendChild(o);});
            [...categories].sort().forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;categoryFilter.appendChild(o);});
        }

        function getFilteredProducts() {
            const q = searchInput.value.toLowerCase().trim();
            const b = brandFilter.value;
            const c = categoryFilter.value;
            return allProducts.filter(p => {
                const ms = !q || (p.ime_proizvoda && p.ime_proizvoda.toLowerCase().includes(q));
                const mb = !b || getBrandDisplay(p, p._sourceUrl).name === b;
                const mc = !c || p.kategorije === c;
                return ms && mb && mc;
            });
        }

        function renderProducts() {
            const filtered = getFilteredProducts();
            grid.innerHTML = '';
            if (!filtered.length) { noResults.style.display='block'; stats.textContent='0 proizvoda'; return; }
            noResults.style.display='none';
            stats.textContent = `${filtered.length} od ${allProducts.length} proizvoda`;

            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';
                const brandInfo = getBrandDisplay(p, p._sourceUrl);
                const mainImg = (p.url_slika && p.url_slika.length > 0) ? p.url_slika[0] : fallback;

                const logoContainer = document.createElement('div');
                logoContainer.className = 'brand-logo-container';
                if (brandInfo.url) {
                    const logoImg = document.createElement('img');
                    logoImg.src = brandInfo.url;
                    logoImg.alt = brandInfo.name;
                    if (brandInfo.name === 'Argon Audio' || brandInfo.name === 'Denon') logoImg.classList.add('force-dark');
                    logoImg.onerror = () => logoContainer.textContent = brandInfo.name;
                    logoContainer.appendChild(logoImg);
                } else logoContainer.textContent = brandInfo.name;

                const colorsHtml = (p.dodatne_informacije?.dostupne_boje || []).slice(0,5).map(c => {
                    if (c.url_uzorka?.startsWith('http')) return `<div class="color-swatch"><img src="${c.url_uzorka}" onerror="this.style.display='none'"/></div>`;
                    if (c.url_uzorka?.startsWith('#')) return `<div class="color-swatch hex" style="--swatch-color:${c.url_uzorka};"></div>`;
                    return `<div class="color-swatch" style="background:#ccc;"></div>`;
                }).join('');

                card.innerHTML = `
                    <div class="card-img">
                        <img src="${mainImg}" alt="${p.ime_proizvoda}" class="product" onerror="this.src='${fallback}'"/>
                    </div>
                    <div class="card-body">
                        <div class="card-category">${p.kategorije || 'N/A'}</div>
                        <div class="card-title">${p.ime_proizvoda || 'Nema imena'}</div>
                        <div class="card-sku">SKU: ${p.sku || 'N/A'}</div>
                        <div class="card-price">${p.cena || 'Cena nedostupna'}</div>
                        <div class="colors">${colorsHtml}</div>
                    </div>
                `;
                card.querySelector('.card-img').prepend(logoContainer);
                card.onclick = () => alert('Modal će biti dodat u sledećoj verziji'); // privremeno
                grid.appendChild(card);
            });
        }

        // Event listeneri
        searchInput.addEventListener('input', renderProducts);
        brandFilter.addEventListener('change', renderProducts);
        categoryFilter.addEventListener('change', renderProducts);
    </script>
</body>
</html>
