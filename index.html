<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Audio Katalog – v1.3.15</title>
    <style>
        :root{--primary:#1a1a1a;--secondary:#2c3e50;--accent:#e74c3c;--border:#ddd;--radius:12px;--shadow:0 4px 12px rgba(0,0,0,.1);}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
        body{background:#f5f7fa;color:var(--primary);line-height:1.6;}
        header{background:var(--primary);color:white;padding:1.5rem 0;text-align:center;box-shadow:var(--shadow);}
        header h1{font-size:2rem;margin-bottom:.5rem;}
        .subtitle{font-size:1rem;opacity:0.9;}
        #updateInfo{color:#27ae60;font-weight:600;}
        .controls{max-width:1200px;margin:2rem auto;padding:0 1rem;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;}
        .search-box,.filter-select{padding:.75rem 1rem;border:1px solid var(--border);border-radius:var(--radius);font-size:1rem;flex:1;min-width:200px;}
        .search-box:focus,.filter-select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(231,76,60,.2);}
        .stats{font-size:.9rem;color:#666;margin-left:auto;}
        .container{max-width:1200px;margin:0 auto;padding:0 1rem;}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;margin-top:1rem;}
        .card{background:white;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:.3s;cursor:pointer;position:relative;}
        .card:hover{transform:translateY(-8px);box-shadow:0 12px 24px rgba(0,0,0,.15);}
        .card-img{height:220px;background:#fff;position:relative;overflow:hidden;}
        .card-img img.product{width:100%;height:100%;object-fit:contain;transition:transform .3s;}
        .card:hover .card-img img.product{transform:scale(1.05);}
        .brand-logo-container{position:absolute;top:10px;left:10px;z-index:3;background:rgba(255,255,255,.95);padding:6px;border-radius:10px;
            box-shadow:0 2px 10px rgba(0,0,0,.2);width:50px;height:50px;display:flex;align-items:center;justify-content:center;}
        .brand-logo-container img{width:40px;height:40px;object-fit:contain;}
        .brand-logo-container img.force-dark{filter:invert(1) hue-rotate(180deg) brightness(.9)!important;}
        .card-body{padding:1rem;display:flex;flex-direction:column;}
        .card-category{font-size:.85rem;color:var(--accent);font-weight:500;margin-bottom:.5rem;text-transform:capitalize;}
        .card-title{font-size:1.1rem;font-weight:600;color:var(--secondary);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
        .card-sku{font-size:.85rem;color:#777;margin-bottom:.5rem;}
        .card-price{font-size:1.3rem;font-weight:700;color:var(--accent);margin:.5rem 0;}
        .colors{display:flex;gap:6px;flex-wrap:wrap;margin-top:auto;padding-top:.75rem;}
        .color-swatch{width:24px;height:24px;border-radius:50%;border:2px solid white;box-shadow:0 0 0 1px #ccc;overflow:hidden;position:relative;}
        .color-swatch img{width:100%;height:100%;object-fit:cover;}
        .color-swatch.hex{background:var(--swatch-color);}
        .color-swatch.has-label::after{content:attr(data-label);position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:white;font-size:9px;padding:3px 6px;border-radius:4px;white-space:nowrap;opacity:0;transition:opacity .2s;z-index:10;}
        .color-swatch.has-label:hover::after{opacity:1;}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;overflow-y:auto;align-items:center;justify-content:center;}
        .modal.active{display:flex;}
        .modal-content{background:white;border-radius:var(--radius);max-width:900px;width:95%;max-height:95vh;overflow-y:auto;position:relative;}
        .modal-close{position:absolute;top:10px;right:15px;background:none;border:none;font-size:2rem;cursor:pointer;color:#aaa;z-index:10;}
        .modal-close:hover{color:var(--accent);}
        .modal-header{padding:1.5rem;background:var(--primary);color:white;border-radius:var(--radius) var(--radius) 0 0;}
        .modal-title{font-size:1.8rem;margin-bottom:.5rem;}
        .modal-brand{font-size:1rem;opacity:.9;}
        .modal-body{padding:2rem;}
        .gallery{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:2rem;justify-content:center;}
        .gallery img{max-width:200px;max-height:200px;object-fit:contain;cursor:pointer;border:2px solid transparent;border-radius:8px;}
        .gallery img:hover{border-color:var(--accent);}
        .modal-info{display:grid;grid-template-columns:1fr 1fr;gap:2rem;}
        .modal-desc{grid-column:span 2;margin-bottom:1.5rem;line-height:1.8;}
        .specs-table{width:100%;border-collapse:collapse;}
        .specs-table th,.specs-table td{padding:.75rem;text-align:left;border-bottom:1px solid #eee;}
        .specs-table th{background:#f9f9f9;width:40%;}
        .colors-big{display:flex;gap:12px;flex-wrap:wrap;margin:1rem 0;}
        .colors-big .color-swatch{width:40px;height:40px;}
        .modal-footer{padding:1.5rem;text-align:center;background:#f9f9f9;border-top:1px solid var(--border);}
        .btn{padding:.75rem 1.5rem;background:var(--accent);color:white;border:none;border-radius:var(--radius);cursor:pointer;font-size:1rem;}
        .btn:hover{background:#c0392b;}
        .loading,.no-results{text-align:center;padding:3rem 1rem;color:#777;font-size:1.1rem;}
        .footer{text-align:center;padding:2rem 1rem;color:#777;font-size:.9rem;margin-top:3rem;border-top:1px solid var(--border);}
        @media(max-width:768px){.modal-info{grid-template-columns:1fr;}.controls{flex-direction:column;}.stats{margin-left:0;}}
    </style>
</head>
<body>
    <header>
        <h1>Audio Katalog</h1>
        <p class="subtitle">Live sa GitHub-a – v1.3.15 <span id="updateInfo"></span></p>
    </header>

    <div class="controls">
        <input type="text" class="search-box" placeholder="Pretraži po imenu..." id="searchInput" />
        <select class="filter-select" id="brandFilter"><option value="">Svi brendovi</option></select>
        <select class="filter-select" id="categoryFilter"><option value="">Sve kategorije</option></select>
        <div class="stats" id="stats">Učitavanje...</div>
    </div>

    <div class="container">
        <div id="loading" class="loading">Učitavanje najnovijih podataka...</div>
        <div id="grid" class="grid" style="display:none;"></div>
        <div id="noResults" class="no-results" style="display:none;">Nema rezultata.</div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">×</button>
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-brand" id="modalBrand"></div>
            </div>
            <div class="modal-body">
                <div class="gallery" id="modalGallery"></div>
                <div class="modal-info">
                    <div class="modal-desc" id="modalDesc"></div>
                    <div>
                        <p><strong>SKU:</strong> <span id="modalSKU"></span></p>
                        <p><strong>Cena:</strong> <span id="modalPrice"></span></p>
                        <p><strong>Kategorija:</strong> <span id="modalCategory"></span></p>
                        <p id="taglineSection"><strong>Tagline:</strong> <span id="modalTagline"></span></p>
                    </div>
                </div>
                <div class="colors-big" id="modalColors"></div>
                <table class="specs-table" id="modalSpecs"></table>
            </div>
            <div class="modal-footer">
                <button class="btn" id="modalLink">Idi na originalnu stranicu</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>web_app_v1.3.15.html – Q Acoustics boje sada 100% u pravim bojama!</p>
    </footer>

    <script>
        async function getLatestCommit() {
            try {
                const r = await fetch('https://api.github.com/repos/MikiMix-Git/SonusArtBA/commits/main');
                const d = await r.json();
                return d.sha;
            } catch { return '50d26ef9994e5858c77f5dc995aff403f99ea1af'; }
        }

        let GITHUB_RAW_BASE = '';
        const files = ['argon_audio_products_all_categories.json','bowers_wilkins_products.json','denon_products.json',
                       'dynaudio_products.json','marantz_all_products.json','qacoustics_products.json'];
        let allProducts = [], brands = new Set(), categories = new Set();
        const grid = document.getElementById('grid');
        const loading = document.getElementById('loading');
        const updateInfo = document.getElementById('updateInfo');
        const stats = document.getElementById('stats');
        const noResults = document.getElementById('noResults');
        const searchInput = document.getElementById('searchInput');
        const brandFilter = document.getElementById('brandFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const fallback = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22><rect width=%22400%22 height=%22300%22 fill=%22%23f0f0f0%22/><text x=%22200%22 y=%22150%22 font-size=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22>No Image</text></svg>';

        const modal = document.getElementById('modal'), modalClose = document.getElementById('modalClose'),
              modalTitle = document.getElementById('modalTitle'), modalBrand = document.getElementById('modalBrand'),
              modalGallery = document.getElementById('modalGallery'), modalDesc = document.getElementById('modalDesc'),
              modalSKU = document.getElementById('modalSKU'), modalPrice = document.getElementById('modalPrice'),
              modalCategory = document.getElementById('modalCategory'), modalTagline = document.getElementById('modalTagline'),
              taglineSection = document.getElementById('taglineSection'), modalColors = document.getElementById('modalColors'),
              modalSpecs = document.getElementById('modalSpecs'), modalLink = document.getElementById('modalLink');

        // ISPRAVLJENA FUNKCIJA – sada Q Acoustics boje rade 100%
        function createColorSwatch(colorObj, big = false) {
            const div = document.createElement('div');
            div.className = `color-swatch${big ? ' big' : ' has-label'}`;

            if (colorObj.url_uzorka && colorObj.url_uzorka.startsWith('http')) {
                const img = document.createElement('img');
                img.src = colorObj.url_uzorka;
                div.appendChild(img);
            } 
            else if (colorObj.hex) {
                div.classList.add('hex');  // ← KLJUČNA LINIJA KOJA JE NEDOSTAJALA
                div.style.setProperty('--swatch-color', colorObj.hex);
            } 
            else if (colorObj.url_uzorka && colorObj.url_uzorka.startsWith('#')) {
                div.classList.add('hex');
                div.style.setProperty('--swatch-color', colorObj.url_uzorka);
            } 
            else {
                div.style.background = '#ccc';
            }

            const label = colorObj.naziv_boje || colorObj.boja || colorObj.color;
            if (label) div.dataset.label = label.trim();

            return div;
        }

        (async () => {
            const commit = await getLatestCommit();
            GITHUB_RAW_BASE = `https://raw.githubusercontent.com/MikiMix-Git/SonusArtBA/${commit}/json`;
            updateInfo.textContent = `– Podaci ažurirani: ${new Date().toLocaleDateString('sr-RS')} (commit ${commit.slice(0,7)})`;

            const responses = await Promise.all(files.map(f => fetch(GITHUB_RAW_BASE + '/' + f)));
            const data = await Promise.all(responses.map(r => r.ok ? r.json() : []));
            allProducts = data.flat();

            allProducts.forEach(p => {
                brands.add(getBrandDisplay(p).name);
                if (p.kategorije) categories.add(p.kategorije);
            });

            populateFilters();
            renderProducts();
            loading.style.display = 'none';
            grid.style.display = 'grid';
        })();

        // ostalo ostaje isto...
        function getBrandDisplay(p) {
            const map = {'qacoustics':'Q Acoustics','dynaudio':'Dynaudio','marantz':'Marantz','denon':'Denon','bowers':'Bowers & Wilkins','argon':'Argon Audio'};
            const logo = p.brend_logo_url || '';
            for (const k in map) if (logo.includes(k)) return {name:map[k], url:logo};
            return {name:'Audio', url:null};
        }

        function populateFilters() {
            [...brands].sort().forEach(b => brandFilter.add(new Option(b,b)));
            [...categories].sort().forEach(c => categoryFilter.add(new Option(c,c)));
        }

        function renderProducts() {
            const q = searchInput.value.toLowerCase().trim();
            const b = brandFilter.value;
            const c = categoryFilter.value;
            const filtered = allProducts.filter(p => 
                (!q || (p.ime_proizvoda && p.ime_proizvoda.toLowerCase().includes(q))) &&
                (!b || getBrandDisplay(p).name === b) &&
                (!c || p.kategorije === c)
            );

            grid.innerHTML = '';
            stats.textContent = `${filtered.length} od ${allProducts.length} proizvoda`;
            if (!filtered.length) { noResults.style.display = 'block'; return; }
            noResults.style.display = 'none';

            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';

                const brand = getBrandDisplay(p);
                const mainImg = p.url_slika?.[0] || fallback;

                const logoDiv = document.createElement('div');
                logoDiv.className = 'brand-logo-container';
                if (brand.url) {
                    const img = document.createElement('img');
                    img.src = brand.url;
                    if (brand.name === 'Argon Audio' || brand.name === 'Denon') img.classList.add('force-dark');
                    img.onerror = () => logoDiv.textContent = brand.name;
                    logoDiv.appendChild(img);
                } else logoDiv.textContent = brand.name;

                const colorsDiv = document.createElement('div');
                colorsDiv.className = 'colors';
                (p.dodatne_informacije?.dostupne_boje || []).slice(0,5).forEach(c => {
                    colorsDiv.appendChild(createColorSwatch(c));
                });

                card.innerHTML = `
                    <div class="card-img"><img src="${mainImg}" class="product" onerror="this.src='${fallback}'"></div>
                    <div class="card-body">
                        <div class="card-category">${p.kategorije||'N/A'}</div>
                        <div class="card-title">${p.ime_proizvoda||'Nema imena'}</div>
                        <div class="card-sku">SKU: ${p.sku||'N/A'}</div>
                        <div class="card-price">${p.cena||'Cena nedostupna'}</div>
                    </div>`;
                card.querySelector('.card-body').appendChild(colorsDiv);
                card.querySelector('.card-img').prepend(logoDiv);
                card.onclick = () => openModal(p);
                grid.appendChild(card);
            });
        }

        // openModal, zatvaranje, pretraga – sve isto kao u v1.3.14

        function openModal(p) {
            modalTitle.textContent = p.ime_proizvoda || 'Nema imena';
            modalBrand.textContent = getBrandDisplay(p).name;
            modalSKU.textContent = p.sku || 'N/A';
            modalPrice.textContent = p.cena || 'Cena nedostupna';
            modalCategory.textContent = p.kategorije || 'N/A';
            modalDesc.innerHTML = p.opis ? p.opis.replace(/\n/g,'<br>') : 'Opis nije dostupan';
            taglineSection.style.display = (p.dodatne_informacije?.tagline && p.dodatne_informacije.tagline !== 'Tagline nedostupan') ? 'block' : 'none';
            if (taglineSection.style.display === 'block') modalTagline.textContent = p.dodatne_informacije.tagline;

            modalGallery.innerHTML = '';
            (p.url_slika||[]).forEach(src => {
                const img = document.createElement('img');
                img.src = src; img.onerror = () => img.src = fallback;
                img.onclick = () => window.open(src,'_blank');
                modalGallery.appendChild(img);
            });

            modalColors.innerHTML = '';
            (p.dodatne_informacije?.dostupne_boje||[]).forEach(c => {
                modalColors.appendChild(createColorSwatch(c, true));
            });

            modalSpecs.innerHTML = '';
            const specs = p.specifikacije || {};
            if (Object.keys(specs).length === 0) modalSpecs.innerHTML = '<tr><td colspan="2">Nema specifikacija</td></tr>';
            else Object.entries(specs).forEach(([k,v]) => modalSpecs.innerHTML += `<tr><th>${k}</th><td>${v}</td></tr>`);

            modalLink.onclick = () => window.open(p.url_proizvoda,'_blank');
            modal.classList.add('active');
        }

        modalClose.onclick = () => modal.classList.remove('active');
        modal.onclick = e => { if (e.target === modal) modal.classList.remove('active'); };
        document.addEventListener('keydown', e => { if (e.key === 'Escape') modal.classList.remove('active'); });

        searchInput.oninput = brandFilter.onchange = categoryFilter.onchange = renderProducts;
    </script>
</body>
</html>
